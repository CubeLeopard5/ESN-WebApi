—‹
?C:\Users\micha\Projects\ESN-WebApi\Business\User\UserService.cs
	namespace 	
Business
 
. 
User 
; 
public 
class 
UserService 
( 
IUnitOfWork 

unitOfWork 
, 
IMapper 
mapper 
, 
ILogger 
< 
UserService 
> 
logger 
,  
IConfiguration 
configuration  
)  !
: 
IUserService 
{ 
public 

async 
Task 
<  
UserLoginResponseDto *
>* +

LoginAsync, 6
(6 7
UserLoginDto7 C
loginDtoD L
)L M
{ 
logger 
. 
LogInformation 
( 
$str I
,I J
loginDtoK S
.S T
EmailT Y
)Y Z
;Z [
var!! 
user!! 
=!! 
await!! 

unitOfWork!! #
.!!# $
Users!!$ )
.!!) *#
GetByEmailWithRoleAsync!!* A
(!!A B
loginDto!!B J
.!!J K
Email!!K P
)!!P Q
;!!Q R
var"" 
hasher"" 
="" 
new"" 
PasswordHasher"" '
<""' (
Bo""( *
.""* +
Models""+ 1
.""1 2
UserBo""2 8
>""8 9
(""9 :
)"": ;
;""; <
if&& 

(&& 
user&& 
==&& 
null&& 
)&& 
{'' 	
var(( 
	dummyUser(( 
=(( 
new(( 
Bo((  "
.((" #
Models((# )
.(() *
UserBo((* 0
(((0 1
)((1 2
;((2 3
var)) 
	dummyHash)) 
=)) 
hasher)) "
.))" #
HashPassword))# /
())/ 0
	dummyUser))0 9
,))9 :
$str)); a
)))a b
;))b c
hasher** 
.**  
VerifyHashedPassword** '
(**' (
	dummyUser**( 1
,**1 2
	dummyHash**3 <
,**< =
loginDto**> F
.**F G
Password**G O
)**O P
;**P Q
logger,, 
.,, 

LogWarning,, 
(,, 
$str,, L
),,L M
;,,M N
throw-- 
new-- '
UnauthorizedAccessException-- 1
(--1 2
$str--2 G
)--G H
;--H I
}.. 	
var00 
result00 
=00 
hasher00 
.00  
VerifyHashedPassword00 0
(000 1
user001 5
,005 6
user007 ;
.00; <
PasswordHash00< H
,00H I
loginDto00J R
.00R S
Password00S [
)00[ \
;00\ ]
if22 

(22 
result22 
==22 &
PasswordVerificationResult22 0
.220 1
Failed221 7
)227 8
{33 	
logger44 
.44 

LogWarning44 
(44 
$str44 L
)44L M
;44M N
throw55 
new55 '
UnauthorizedAccessException55 1
(551 2
$str552 G
)55G H
;55H I
}66 	
if99 

(99 
user99 
.99 
Status99 
==99 

UserStatus99 %
.99% &
Pending99& -
)99- .
{:: 	
logger;; 
.;; 

LogWarning;; 
(;; 
$str;; j
,;;j k
user;;l p
.;;p q
Id;;q s
);;s t
;;;t u
throw<< 
new<< $
ForbiddenAccessException<< .
(<<. /
$str<</ p
)<<p q
;<<q r
}== 	
if?? 

(?? 
user?? 
.?? 
Status?? 
==?? 

UserStatus?? %
.??% &
Rejected??& .
)??. /
{@@ 	
loggerAA 
.AA 

LogWarningAA 
(AA 
$strAA k
,AAk l
userAAm q
.AAq r
IdAAr t
)AAt u
;AAu v
throwBB 
newBB $
ForbiddenAccessExceptionBB .
(BB. /
$strBB/ g
)BBg h
;BBh i
}CC 	
varEE 
tokenEE 
=EE 
GenerateJwtTokenEE $
(EE$ %
userEE% )
)EE) *
;EE* +
loggerGG 
.GG 
LogInformationGG 
(GG 
$strGG Y
,GGY Z
loginDtoGG[ c
.GGc d
EmailGGd i
)GGi j
;GGj k
returnII 
newII  
UserLoginResponseDtoII '
{JJ 	
TokenKK 
=KK 
tokenKK 
,KK 
UserLL 
=LL 
mapperLL 
.LL 
MapLL 
<LL 
UserDtoLL %
>LL% &
(LL& '
userLL' +
)LL+ ,
}MM 	
;MM	 

}NN 
publicQQ 

asyncQQ 
TaskQQ 
<QQ  
UserLoginResponseDtoQQ *
>QQ* +
RefreshTokenAsyncQQ, =
(QQ= >
stringQQ> D
tokenQQE J
)QQJ K
{RR 
loggerSS 
.SS 
LogInformationSS 
(SS 
$strSS D
)SSD E
;SSE F
varUU 
tokenHandlerUU 
=UU 
newUU #
JwtSecurityTokenHandlerUU 6
(UU6 7
)UU7 8
;UU8 9
varVV 
	jwtConfigVV 
=VV 
configurationVV %
.VV% &

GetSectionVV& 0
(VV0 1
$strVV1 6
)VV6 7
;VV7 8
varWW 
keyWW 
=WW 
EncodingWW 
.WW 
UTF8WW 
.WW  
GetBytesWW  (
(WW( )
	jwtConfigWW) 2
[WW2 3
$strWW3 8
]WW8 9
!WW9 :
)WW: ;
;WW; <
tryYY 
{ZZ 	
var\\  
validationParameters\\ $
=\\% &
new\\' *%
TokenValidationParameters\\+ D
{]] $
ValidateIssuerSigningKey^^ (
=^^) *
true^^+ /
,^^/ 0
IssuerSigningKey__  
=__! "
new__# & 
SymmetricSecurityKey__' ;
(__; <
key__< ?
)__? @
,__@ A
ValidateIssuer`` 
=``  
true``! %
,``% &
ValidIssueraa 
=aa 
	jwtConfigaa '
[aa' (
$straa( 0
]aa0 1
,aa1 2
ValidateAudiencebb  
=bb! "
truebb# '
,bb' (
ValidAudiencecc 
=cc 
	jwtConfigcc  )
[cc) *
$strcc* 4
]cc4 5
,cc5 6
ValidateLifetimedd  
=dd! "
falsedd# (
,dd( )
	ClockSkewee 
=ee 
TimeSpanee $
.ee$ %
Zeroee% )
}ff 
;ff 
varhh 
	principalhh 
=hh 
tokenHandlerhh (
.hh( )
ValidateTokenhh) 6
(hh6 7
tokenhh7 <
,hh< = 
validationParametershh> R
,hhR S
outhhT W
varhhX [
validatedTokenhh\ j
)hhj k
;hhk l
varkk 
jwtTokenkk 
=kk 
validatedTokenkk )
askk* ,
JwtSecurityTokenkk- =
;kk= >
ifll 
(ll 
jwtTokenll 
!=ll 
nullll  
)ll  !
{mm 
varnn 
issuedAtnn 
=nn 
jwtTokennn '
.nn' (
IssuedAtnn( 0
;nn0 1
varoo 
maxRefreshDurationoo &
=oo' (
TimeSpanoo) 1
.oo1 2
FromDaysoo2 :
(oo: ;
$numoo; <
)oo< =
;oo= >
ifqq 
(qq 
DateTimeqq 
.qq 
UtcNowqq #
-qq$ %
issuedAtqq& .
>qq/ 0
maxRefreshDurationqq1 C
)qqC D
{rr 
loggerss 
.ss 

LogWarningss %
(ss% &
$strss& w
,ssw x
issuedAt	ssy Å
)
ssÅ Ç
;
ssÇ É
throwtt 
newtt '
UnauthorizedAccessExceptiontt 9
(tt9 :
$strtt: c
)ttc d
;ttd e
}uu 
}vv 
varyy 
emailyy 
=yy 
	principalyy !
.yy! "
	FindFirstyy" +
(yy+ ,

ClaimTypesyy, 6
.yy6 7
NameIdentifieryy7 E
)yyE F
?yyF G
.yyG H
ValueyyH M
??zz 
	principalzz #
.zz# $
	FindFirstzz$ -
(zz- .#
JwtRegisteredClaimNameszz. E
.zzE F
SubzzF I
)zzI J
?zzJ K
.zzK L
ValuezzL Q
;zzQ R
if|| 
(|| 
string|| 
.|| 
IsNullOrEmpty|| $
(||$ %
email||% *
)||* +
)||+ ,
{}} 
logger~~ 
.~~ 

LogWarning~~ !
(~~! "
$str~~" a
)~~a b
;~~b c
throw 
new '
UnauthorizedAccessException 5
(5 6
$str6 E
)E F
;F G
}
ÄÄ 
var
ÉÉ 
user
ÉÉ 
=
ÉÉ 
await
ÉÉ 

unitOfWork
ÉÉ '
.
ÉÉ' (
Users
ÉÉ( -
.
ÉÉ- .%
GetByEmailWithRoleAsync
ÉÉ. E
(
ÉÉE F
email
ÉÉF K
)
ÉÉK L
;
ÉÉL M
if
ÖÖ 
(
ÖÖ 
user
ÖÖ 
==
ÖÖ 
null
ÖÖ 
)
ÖÖ 
{
ÜÜ 
logger
áá 
.
áá 

LogWarning
áá !
(
áá! "
$str
áá" d
,
áád e
email
ááf k
)
áák l
;
áál m
throw
àà 
new
àà "
KeyNotFoundException
àà .
(
àà. /
$"
àà/ 1
$str
àà1 A
{
ààA B
email
ààB G
}
ààG H
"
ààH I
)
ààI J
;
ààJ K
}
ââ 
var
åå 
newToken
åå 
=
åå 
GenerateJwtToken
åå +
(
åå+ ,
user
åå, 0
)
åå0 1
;
åå1 2
logger
éé 
.
éé 
LogInformation
éé !
(
éé! "
$str
éé" d
,
ééd e
user
ééf j
.
ééj k
Email
éék p
)
éép q
;
ééq r
return
êê 
new
êê "
UserLoginResponseDto
êê +
{
ëë 
Token
íí 
=
íí 
newToken
íí  
,
íí  !
User
ìì 
=
ìì 
mapper
ìì 
.
ìì 
Map
ìì !
<
ìì! "
UserDto
ìì" )
>
ìì) *
(
ìì* +
user
ìì+ /
)
ìì/ 0
}
îî 
;
îî 
}
ïï 	
catch
ññ 
(
ññ $
SecurityTokenException
ññ %
ex
ññ& (
)
ññ( )
{
óó 	
logger
òò 
.
òò 

LogWarning
òò 
(
òò 
ex
òò  
,
òò  !
$str
òò" Q
)
òòQ R
;
òòR S
throw
ôô 
new
ôô )
UnauthorizedAccessException
ôô 1
(
ôô1 2
$str
ôô2 A
,
ôôA B
ex
ôôC E
)
ôôE F
;
ôôF G
}
öö 	
}
õõ 
public
ûû 

async
ûû 
Task
ûû 
<
ûû 
UserDto
ûû 
?
ûû 
>
ûû !
GetCurrentUserAsync
ûû  3
(
ûû3 4
string
ûû4 :
	userEmail
ûû; D
)
ûûD E
{
üü 
logger
†† 
.
†† 
LogInformation
†† 
(
†† 
$str
†† R
,
††R S
	userEmail
††T ]
)
††] ^
;
††^ _
var
¢¢ 
user
¢¢ 
=
¢¢ 
await
¢¢ 

unitOfWork
¢¢ #
.
¢¢# $
Users
¢¢$ )
.
¢¢) *
GetByEmailAsync
¢¢* 9
(
¢¢9 :
	userEmail
¢¢: C
)
¢¢C D
;
¢¢D E
if
££ 

(
££ 
user
££ 
==
££ 
null
££ 
)
££ 
{
§§ 	
logger
•• 
.
•• 

LogWarning
•• 
(
•• 
$str
•• \
,
••\ ]
	userEmail
••^ g
)
••g h
;
••h i
return
¶¶ 
null
¶¶ 
;
¶¶ 
}
ßß 	
logger
©© 
.
©© 
LogInformation
©© 
(
©© 
$str
©© U
,
©©U V
	userEmail
©©W `
)
©©` a
;
©©a b
return
´´ 
mapper
´´ 
.
´´ 
Map
´´ 
<
´´ 
UserDto
´´ !
>
´´! "
(
´´" #
user
´´# '
)
´´' (
;
´´( )
}
¨¨ 
[
ØØ 
Obsolete
ØØ 
(
ØØ 
$str
ØØ v
)
ØØv w
]
ØØw x
public
∞∞ 

async
∞∞ 
Task
∞∞ 
<
∞∞ 
IEnumerable
∞∞ !
<
∞∞! "
UserDto
∞∞" )
>
∞∞) *
>
∞∞* +
GetAllUsersAsync
∞∞, <
(
∞∞< =
)
∞∞= >
{
±± 
logger
≤≤ 
.
≤≤ 
LogInformation
≤≤ 
(
≤≤ 
$str
≤≤ `
)
≤≤` a
;
≤≤a b
var
¥¥ 
users
¥¥ 
=
¥¥ 
await
¥¥ 

unitOfWork
¥¥ $
.
¥¥$ %
Users
¥¥% *
.
¥¥* +
GetAllAsync
¥¥+ 6
(
¥¥6 7
)
¥¥7 8
;
¥¥8 9
logger
∂∂ 
.
∂∂ 
LogInformation
∂∂ 
(
∂∂ 
$str
∂∂ _
,
∂∂_ `
users
∂∂a f
.
∂∂f g
Count
∂∂g l
(
∂∂l m
)
∂∂m n
)
∂∂n o
;
∂∂o p
return
∏∏ 
mapper
∏∏ 
.
∏∏ 
Map
∏∏ 
<
∏∏ 
IEnumerable
∏∏ %
<
∏∏% &
UserDto
∏∏& -
>
∏∏- .
>
∏∏. /
(
∏∏/ 0
users
∏∏0 5
)
∏∏5 6
;
∏∏6 7
}
ππ 
public
ºº 

async
ºº 
Task
ºº 
<
ºº 
PagedResult
ºº !
<
ºº! "
UserDto
ºº" )
>
ºº) *
>
ºº* +
GetAllUsersAsync
ºº, <
(
ºº< =
PaginationParams
ºº= M

pagination
ººN X
)
ººX Y
{
ΩΩ 
logger
ææ 
.
ææ 
LogInformation
ææ 
(
ææ 
$str
ææ t
,
ææt u

pagination
øø 
.
øø 

PageNumber
øø !
,
øø! "

pagination
øø# -
.
øø- .
PageSize
øø. 6
)
øø6 7
;
øø7 8
var
¡¡ 
(
¡¡ 
items
¡¡ 
,
¡¡ 

totalCount
¡¡ 
)
¡¡ 
=
¡¡  !
await
¡¡" '

unitOfWork
¡¡( 2
.
¡¡2 3
Users
¡¡3 8
.
¡¡8 9
GetPagedAsync
¡¡9 F
(
¡¡F G

pagination
¬¬ 
.
¬¬ 
Skip
¬¬ 
,
¬¬ 

pagination
√√ 
.
√√ 
PageSize
√√ 
)
√√  
;
√√  !
var
≈≈ 
dtos
≈≈ 
=
≈≈ 
mapper
≈≈ 
.
≈≈ 
Map
≈≈ 
<
≈≈ 
List
≈≈ "
<
≈≈" #
UserDto
≈≈# *
>
≈≈* +
>
≈≈+ ,
(
≈≈, -
items
≈≈- 2
)
≈≈2 3
;
≈≈3 4
logger
«« 
.
«« 
LogInformation
«« 
(
«« 
$str
«« u
,
««u v
dtos
»» 
.
»» 
Count
»» 
,
»» 

totalCount
»» "
)
»»" #
;
»»# $
return
   
new
   
PagedResult
   
<
   
UserDto
   &
>
  & '
(
  ' (
dtos
  ( ,
,
  , -

totalCount
  . 8
,
  8 9

pagination
  : D
.
  D E

PageNumber
  E O
,
  O P

pagination
  Q [
.
  [ \
PageSize
  \ d
)
  d e
;
  e f
}
ÀÀ 
public
ŒŒ 

async
ŒŒ 
Task
ŒŒ 
<
ŒŒ 
UserDto
ŒŒ 
?
ŒŒ 
>
ŒŒ 
GetUserByIdAsync
ŒŒ  0
(
ŒŒ0 1
int
ŒŒ1 4
id
ŒŒ5 7
)
ŒŒ7 8
{
œœ 
logger
–– 
.
–– 
LogInformation
–– 
(
–– 
$str
–– S
,
––S T
id
––U W
)
––W X
;
––X Y
var
““ 
user
““ 
=
““ 
await
““ 

unitOfWork
““ #
.
““# $
Users
““$ )
.
““) *
GetByIdAsync
““* 6
(
““6 7
id
““7 9
)
““9 :
;
““: ;
if
‘‘ 

(
‘‘ 
user
‘‘ 
==
‘‘ 
null
‘‘ 
)
‘‘ 
{
’’ 	
logger
÷÷ 
.
÷÷ 

LogWarning
÷÷ 
(
÷÷ 
$str
÷÷ R
,
÷÷R S
id
÷÷T V
)
÷÷V W
;
÷÷W X
return
◊◊ 
null
◊◊ 
;
◊◊ 
}
ÿÿ 	
logger
⁄⁄ 
.
⁄⁄ 
LogInformation
⁄⁄ 
(
⁄⁄ 
$str
⁄⁄ V
,
⁄⁄V W
id
⁄⁄X Z
)
⁄⁄Z [
;
⁄⁄[ \
return
‹‹ 
mapper
‹‹ 
.
‹‹ 
Map
‹‹ 
<
‹‹ 
UserDto
‹‹ !
>
‹‹! "
(
‹‹" #
user
‹‹# '
)
‹‹' (
;
‹‹( )
}
›› 
public
‡‡ 

async
‡‡ 
Task
‡‡ 
<
‡‡ 
IEnumerable
‡‡ !
<
‡‡! "
UserDto
‡‡" )
>
‡‡) *
>
‡‡* + 
GetEsnMembersAsync
‡‡, >
(
‡‡> ?
)
‡‡? @
{
·· 
logger
‚‚ 
.
‚‚ 
LogInformation
‚‚ 
(
‚‚ 
$str
‚‚ E
)
‚‚E F
;
‚‚F G
var
‰‰ 

esnMembers
‰‰ 
=
‰‰ 
await
‰‰ 

unitOfWork
‰‰ )
.
‰‰) *
Users
‰‰* /
.
‰‰/ 0 
GetEsnMembersAsync
‰‰0 B
(
‰‰B C
)
‰‰C D
;
‰‰D E
logger
ÊÊ 
.
ÊÊ 
LogInformation
ÊÊ 
(
ÊÊ 
$str
ÊÊ c
,
ÊÊc d

esnMembers
ÊÊe o
.
ÊÊo p
Count
ÊÊp u
(
ÊÊu v
)
ÊÊv w
)
ÊÊw x
;
ÊÊx y
return
ËË 
mapper
ËË 
.
ËË 
Map
ËË 
<
ËË 
IEnumerable
ËË %
<
ËË% &
UserDto
ËË& -
>
ËË- .
>
ËË. /
(
ËË/ 0

esnMembers
ËË0 :
)
ËË: ;
;
ËË; <
}
ÈÈ 
public
ÏÏ 

async
ÏÏ 
Task
ÏÏ 
<
ÏÏ 
UserDto
ÏÏ 
>
ÏÏ 
CreateUserAsync
ÏÏ .
(
ÏÏ. /
UserCreateDto
ÏÏ/ <
	createDto
ÏÏ= F
)
ÏÏF G
{
ÌÌ 
logger
ÓÓ 
.
ÓÓ 
LogInformation
ÓÓ 
(
ÓÓ 
$str
ÓÓ N
,
ÓÓN O
	createDto
ÓÓP Y
.
ÓÓY Z
Email
ÓÓZ _
)
ÓÓ_ `
;
ÓÓ` a
var
 
existingUser
 
=
 
await
  

unitOfWork
! +
.
+ ,
Users
, 1
.
1 2
GetByEmailAsync
2 A
(
A B
	createDto
B K
.
K L
Email
L Q
)
Q R
;
R S
if
ÚÚ 

(
ÚÚ 
existingUser
ÚÚ 
!=
ÚÚ 
null
ÚÚ  
)
ÚÚ  !
{
ÛÛ 	
logger
ÙÙ 
.
ÙÙ 

LogWarning
ÙÙ 
(
ÙÙ 
$str
ÙÙ V
,
ÙÙV W
	createDto
ÙÙX a
.
ÙÙa b
Email
ÙÙb g
)
ÙÙg h
;
ÙÙh i
throw
ıı 
new
ıı '
InvalidOperationException
ıı /
(
ıı/ 0
$"
ıı0 2
$str
ıı2 D
{
ııD E
	createDto
ııE N
.
ııN O
Email
ııO T
}
ııT U
$str
ııU e
"
ııe f
)
ııf g
;
ııg h
}
ˆˆ 	
var
¯¯ 
user
¯¯ 
=
¯¯ 
mapper
¯¯ 
.
¯¯ 
Map
¯¯ 
<
¯¯ 
Bo
¯¯  
.
¯¯  !
Models
¯¯! '
.
¯¯' (
UserBo
¯¯( .
>
¯¯. /
(
¯¯/ 0
	createDto
¯¯0 9
)
¯¯9 :
;
¯¯: ;
var
˙˙ 
hasher
˙˙ 
=
˙˙ 
new
˙˙ 
PasswordHasher
˙˙ '
<
˙˙' (
Bo
˙˙( *
.
˙˙* +
Models
˙˙+ 1
.
˙˙1 2
UserBo
˙˙2 8
>
˙˙8 9
(
˙˙9 :
)
˙˙: ;
;
˙˙; <
user
˚˚ 
.
˚˚ 
PasswordHash
˚˚ 
=
˚˚ 
hasher
˚˚ "
.
˚˚" #
HashPassword
˚˚# /
(
˚˚/ 0
user
˚˚0 4
,
˚˚4 5
	createDto
˚˚6 ?
.
˚˚? @
Password
˚˚@ H
)
˚˚H I
;
˚˚I J
await
˝˝ 

unitOfWork
˝˝ 
.
˝˝ 
Users
˝˝ 
.
˝˝ 
AddAsync
˝˝ '
(
˝˝' (
user
˝˝( ,
)
˝˝, -
;
˝˝- .
await
˛˛ 

unitOfWork
˛˛ 
.
˛˛ 
SaveChangesAsync
˛˛ )
(
˛˛) *
)
˛˛* +
;
˛˛+ ,
logger
ÄÄ 
.
ÄÄ 
LogInformation
ÄÄ 
(
ÄÄ 
$str
ÄÄ Q
,
ÄÄQ R
user
ÄÄS W
.
ÄÄW X
Email
ÄÄX ]
)
ÄÄ] ^
;
ÄÄ^ _
return
ÇÇ 
mapper
ÇÇ 
.
ÇÇ 
Map
ÇÇ 
<
ÇÇ 
UserDto
ÇÇ !
>
ÇÇ! "
(
ÇÇ" #
user
ÇÇ# '
)
ÇÇ' (
;
ÇÇ( )
}
ÉÉ 
public
ÜÜ 

async
ÜÜ 
Task
ÜÜ 
<
ÜÜ 
UserDto
ÜÜ 
?
ÜÜ 
>
ÜÜ !
UpdatePasswordAsync
ÜÜ  3
(
ÜÜ3 4
int
ÜÜ4 7
id
ÜÜ8 :
,
ÜÜ: ;#
UserPasswordChangeDto
ÜÜ< Q
passwordDto
ÜÜR ]
)
ÜÜ] ^
{
áá 
logger
àà 
.
àà 
LogInformation
àà 
(
àà 
$str
àà V
,
ààV W
id
ààX Z
)
ààZ [
;
àà[ \
var
ää 
user
ää 
=
ää 
await
ää 

unitOfWork
ää #
.
ää# $
Users
ää$ )
.
ää) *
GetByIdAsync
ää* 6
(
ää6 7
id
ää7 9
)
ää9 :
;
ää: ;
if
ãã 

(
ãã 
user
ãã 
==
ãã 
null
ãã 
)
ãã 
{
åå 	
logger
çç 
.
çç 

LogWarning
çç 
(
çç 
$str
çç U
,
ççU V
id
ççW Y
)
ççY Z
;
ççZ [
return
éé 
null
éé 
;
éé 
}
èè 	
var
ëë 
hasher
ëë 
=
ëë 
new
ëë 
PasswordHasher
ëë '
<
ëë' (
Bo
ëë( *
.
ëë* +
Models
ëë+ 1
.
ëë1 2
UserBo
ëë2 8
>
ëë8 9
(
ëë9 :
)
ëë: ;
;
ëë; <
var
îî  
verificationResult
îî 
=
îî  
hasher
îî! '
.
îî' ("
VerifyHashedPassword
îî( <
(
îî< =
user
îî= A
,
îîA B
user
îîC G
.
îîG H
PasswordHash
îîH T
,
îîT U
passwordDto
îîV a
.
îîa b
OldPassword
îîb m
)
îîm n
;
îîn o
if
ïï 

(
ïï  
verificationResult
ïï 
==
ïï !(
PasswordVerificationResult
ïï" <
.
ïï< =
Failed
ïï= C
)
ïïC D
{
ññ 	
logger
óó 
.
óó 

LogWarning
óó 
(
óó 
$str
óó h
,
óóh i
id
óój l
)
óól m
;
óóm n
throw
òò 
new
òò )
UnauthorizedAccessException
òò 1
(
òò1 2
$str
òò2 Q
)
òòQ R
;
òòR S
}
ôô 	
var
úú 
hashed
úú 
=
úú 
hasher
úú 
.
úú 
HashPassword
úú (
(
úú( )
user
úú) -
,
úú- .
passwordDto
úú/ :
.
úú: ;
NewPassword
úú; F
)
úúF G
;
úúG H
user
ùù 
.
ùù 
PasswordHash
ùù 
=
ùù 
hashed
ùù "
;
ùù" #
try
üü 
{
†† 	

unitOfWork
°° 
.
°° 
Users
°° 
.
°° 
Update
°° #
(
°°# $
user
°°$ (
)
°°( )
;
°°) *
await
¢¢ 

unitOfWork
¢¢ 
.
¢¢ 
SaveChangesAsync
¢¢ -
(
¢¢- .
)
¢¢. /
;
¢¢/ 0
logger
££ 
.
££ 
LogInformation
££ !
(
££! "
$str
££" s
,
££s t
id
££u w
)
££w x
;
££x y
}
§§ 	
catch
•• 
(
•• 
	Exception
•• 
ex
•• 
)
•• 
{
¶¶ 	
if
ßß 
(
ßß 
!
ßß 
await
ßß 

unitOfWork
ßß !
.
ßß! "
Users
ßß" '
.
ßß' (
AnyAsync
ßß( 0
(
ßß0 1
e
ßß1 2
=>
ßß3 5
e
ßß6 7
.
ßß7 8
Id
ßß8 :
==
ßß; =
id
ßß> @
)
ßß@ A
)
ßßA B
{
®® 
logger
©© 
.
©© 

LogWarning
©© !
(
©©! "
$str
©©" {
,
©©{ |
id
©©} 
)©© Ä
;©©Ä Å
return
™™ 
null
™™ 
;
™™ 
}
´´ 
logger
¨¨ 
.
¨¨ 
LogError
¨¨ 
(
¨¨ 
ex
¨¨ 
,
¨¨ 
$str
¨¨  i
,
¨¨i j
id
¨¨k m
)
¨¨m n
;
¨¨n o
throw
≠≠ 
;
≠≠ 
}
ÆÆ 	
logger
∞∞ 
.
∞∞ 
LogInformation
∞∞ 
(
∞∞ 
$str
∞∞ U
,
∞∞U V
user
∞∞W [
.
∞∞[ \
Email
∞∞\ a
)
∞∞a b
;
∞∞b c
return
≤≤ 
mapper
≤≤ 
.
≤≤ 
Map
≤≤ 
<
≤≤ 
UserDto
≤≤ !
>
≤≤! "
(
≤≤" #
user
≤≤# '
)
≤≤' (
;
≤≤( )
}
≥≥ 
public
∂∂ 

async
∂∂ 
Task
∂∂ 
<
∂∂ 
UserDto
∂∂ 
?
∂∂ 
>
∂∂ 
UpdateUserAsync
∂∂  /
(
∂∂/ 0
int
∂∂0 3
id
∂∂4 6
,
∂∂6 7
UserUpdateDto
∂∂8 E
userDto
∂∂F M
)
∂∂M N
{
∑∑ 
logger
∏∏ 
.
∏∏ 
LogInformation
∏∏ 
(
∏∏ 
$str
∏∏ _
,
∏∏_ `
id
∏∏a c
,
∏∏c d
userDto
∏∏e l
.
∏∏l m
Email
∏∏m r
)
∏∏r s
;
∏∏s t
var
∫∫ 
user
∫∫ 
=
∫∫ 
await
∫∫ 

unitOfWork
∫∫ #
.
∫∫# $
Users
∫∫$ )
.
∫∫) *
GetByIdAsync
∫∫* 6
(
∫∫6 7
id
∫∫7 9
)
∫∫9 :
;
∫∫: ;
if
ªª 

(
ªª 
user
ªª 
==
ªª 
null
ªª 
)
ªª 
{
ºº 	
logger
ΩΩ 
.
ΩΩ 

LogWarning
ΩΩ 
(
ΩΩ 
$str
ΩΩ Q
,
ΩΩQ R
id
ΩΩS U
)
ΩΩU V
;
ΩΩV W
return
ææ 
null
ææ 
;
ææ 
}
øø 	
mapper
¡¡ 
.
¡¡ 
Map
¡¡ 
(
¡¡ 
userDto
¡¡ 
,
¡¡ 
user
¡¡  
)
¡¡  !
;
¡¡! "
try
√√ 
{
ƒƒ 	

unitOfWork
≈≈ 
.
≈≈ 
Users
≈≈ 
.
≈≈ 
Update
≈≈ #
(
≈≈# $
user
≈≈$ (
)
≈≈( )
;
≈≈) *
await
∆∆ 

unitOfWork
∆∆ 
.
∆∆ 
SaveChangesAsync
∆∆ -
(
∆∆- .
)
∆∆. /
;
∆∆/ 0
logger
«« 
.
«« 
LogInformation
«« !
(
««! "
$str
««" `
,
««` a
id
««b d
)
««d e
;
««e f
}
»» 	
catch
…… 
(
…… 
	Exception
…… 
ex
…… 
)
…… 
{
   	
if
ÀÀ 
(
ÀÀ 
!
ÀÀ 
await
ÀÀ 

unitOfWork
ÀÀ !
.
ÀÀ! "
Users
ÀÀ" '
.
ÀÀ' (
AnyAsync
ÀÀ( 0
(
ÀÀ0 1
e
ÀÀ1 2
=>
ÀÀ3 5
e
ÀÀ6 7
.
ÀÀ7 8
Id
ÀÀ8 :
==
ÀÀ; =
id
ÀÀ> @
)
ÀÀ@ A
)
ÀÀA B
{
ÃÃ 
logger
ÕÕ 
.
ÕÕ 

LogWarning
ÕÕ !
(
ÕÕ! "
$str
ÕÕ" w
,
ÕÕw x
id
ÕÕy {
)
ÕÕ{ |
;
ÕÕ| }
return
ŒŒ 
null
ŒŒ 
;
ŒŒ 
}
œœ 
logger
–– 
.
–– 
LogError
–– 
(
–– 
ex
–– 
,
–– 
$str
––  e
,
––e f
id
––g i
)
––i j
;
––j k
throw
—— 
;
—— 
}
““ 	
logger
‘‘ 
.
‘‘ 
LogInformation
‘‘ 
(
‘‘ 
$str
‘‘ Q
,
‘‘Q R
user
‘‘S W
.
‘‘W X
Email
‘‘X ]
)
‘‘] ^
;
‘‘^ _
return
÷÷ 
mapper
÷÷ 
.
÷÷ 
Map
÷÷ 
<
÷÷ 
UserDto
÷÷ !
>
÷÷! "
(
÷÷" #
user
÷÷# '
)
÷÷' (
;
÷÷( )
}
◊◊ 
public
⁄⁄ 

async
⁄⁄ 
Task
⁄⁄ 
<
⁄⁄ 
UserDto
⁄⁄ 
?
⁄⁄ 
>
⁄⁄ 
DeleteUserAsync
⁄⁄  /
(
⁄⁄/ 0
int
⁄⁄0 3
id
⁄⁄4 6
)
⁄⁄6 7
{
€€ 
logger
‹‹ 
.
‹‹ 
LogInformation
‹‹ 
(
‹‹ 
$str
‹‹ R
,
‹‹R S
id
‹‹T V
)
‹‹V W
;
‹‹W X
var
ﬁﬁ 
user
ﬁﬁ 
=
ﬁﬁ 
await
ﬁﬁ 

unitOfWork
ﬁﬁ #
.
ﬁﬁ# $
Users
ﬁﬁ$ )
.
ﬁﬁ) *
GetByIdAsync
ﬁﬁ* 6
(
ﬁﬁ6 7
id
ﬁﬁ7 9
)
ﬁﬁ9 :
;
ﬁﬁ: ;
if
ﬂﬂ 

(
ﬂﬂ 
user
ﬂﬂ 
==
ﬂﬂ 
null
ﬂﬂ 
)
ﬂﬂ 
{
‡‡ 	
logger
·· 
.
·· 

LogWarning
·· 
(
·· 
$str
·· Q
,
··Q R
id
··S U
)
··U V
;
··V W
return
‚‚ 
null
‚‚ 
;
‚‚ 
}
„„ 	

unitOfWork
ÂÂ 
.
ÂÂ 
Users
ÂÂ 
.
ÂÂ 
Delete
ÂÂ 
(
ÂÂ  
user
ÂÂ  $
)
ÂÂ$ %
;
ÂÂ% &
await
ÊÊ 

unitOfWork
ÊÊ 
.
ÊÊ 
SaveChangesAsync
ÊÊ )
(
ÊÊ) *
)
ÊÊ* +
;
ÊÊ+ ,
logger
ËË 
.
ËË 
LogInformation
ËË 
(
ËË 
$str
ËË Q
,
ËËQ R
user
ËËS W
.
ËËW X
Email
ËËX ]
)
ËË] ^
;
ËË^ _
return
ÍÍ 
mapper
ÍÍ 
.
ÍÍ 
Map
ÍÍ 
<
ÍÍ 
UserDto
ÍÍ !
>
ÍÍ! "
(
ÍÍ" #
user
ÍÍ# '
)
ÍÍ' (
;
ÍÍ( )
}
ÎÎ 
public
ÓÓ 

async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 
IEnumerable
ÓÓ !
<
ÓÓ! "
UserDto
ÓÓ" )
>
ÓÓ) *
>
ÓÓ* +#
GetUsersByStatusAsync
ÓÓ, A
(
ÓÓA B

UserStatus
ÓÓB L
status
ÓÓM S
)
ÓÓS T
{
ÔÔ 
logger
 
.
 
LogInformation
 
(
 
$str
 \
,
\ ]
status
^ d
)
d e
;
e f
var
ÚÚ 
users
ÚÚ 
=
ÚÚ 
await
ÚÚ 

unitOfWork
ÚÚ $
.
ÚÚ$ %
Users
ÚÚ% *
.
ÚÚ* +
GetAllAsync
ÚÚ+ 6
(
ÚÚ6 7
)
ÚÚ7 8
;
ÚÚ8 9
var
ÛÛ 
filteredUsers
ÛÛ 
=
ÛÛ 
users
ÛÛ !
.
ÛÛ! "
Where
ÛÛ" '
(
ÛÛ' (
u
ÛÛ( )
=>
ÛÛ* ,
u
ÛÛ- .
.
ÛÛ. /
Status
ÛÛ/ 5
==
ÛÛ6 8
status
ÛÛ9 ?
)
ÛÛ? @
;
ÛÛ@ A
logger
ıı 
.
ıı 
LogInformation
ıı 
(
ıı 
$str
ıı j
,
ııj k
filteredUsers
ˆˆ 
.
ˆˆ 
Count
ˆˆ 
(
ˆˆ  
)
ˆˆ  !
,
ˆˆ! "
status
ˆˆ# )
)
ˆˆ) *
;
ˆˆ* +
return
¯¯ 
mapper
¯¯ 
.
¯¯ 
Map
¯¯ 
<
¯¯ 
IEnumerable
¯¯ %
<
¯¯% &
UserDto
¯¯& -
>
¯¯- .
>
¯¯. /
(
¯¯/ 0
filteredUsers
¯¯0 =
)
¯¯= >
;
¯¯> ?
}
˘˘ 
public
¸¸ 

async
¸¸ 
Task
¸¸ 
ApproveUserAsync
¸¸ &
(
¸¸& '
int
¸¸' *
userId
¸¸+ 1
)
¸¸1 2
{
˝˝ 
logger
˛˛ 
.
˛˛ 
LogInformation
˛˛ 
(
˛˛ 
$str
˛˛ W
,
˛˛W X
userId
˛˛Y _
)
˛˛_ `
;
˛˛` a
var
ÄÄ 
user
ÄÄ 
=
ÄÄ 
await
ÄÄ 

unitOfWork
ÄÄ #
.
ÄÄ# $
Users
ÄÄ$ )
.
ÄÄ) *
GetByIdAsync
ÄÄ* 6
(
ÄÄ6 7
userId
ÄÄ7 =
)
ÄÄ= >
;
ÄÄ> ?
if
ÅÅ 

(
ÅÅ 
user
ÅÅ 
==
ÅÅ 
null
ÅÅ 
)
ÅÅ 
{
ÇÇ 	
logger
ÉÉ 
.
ÉÉ 

LogWarning
ÉÉ 
(
ÉÉ 
$str
ÉÉ V
,
ÉÉV W
userId
ÉÉX ^
)
ÉÉ^ _
;
ÉÉ_ `
throw
ÑÑ 
new
ÑÑ "
KeyNotFoundException
ÑÑ *
(
ÑÑ* +
$"
ÑÑ+ -
$str
ÑÑ- 2
{
ÑÑ2 3
userId
ÑÑ3 9
}
ÑÑ9 :
$str
ÑÑ: D
"
ÑÑD E
)
ÑÑE F
;
ÑÑF G
}
ÖÖ 	
user
áá 
.
áá 
Status
áá 
=
áá 

UserStatus
áá  
.
áá  !
Approved
áá! )
;
áá) *

unitOfWork
àà 
.
àà 
Users
àà 
.
àà 
Update
àà 
(
àà  
user
àà  $
)
àà$ %
;
àà% &
await
ââ 

unitOfWork
ââ 
.
ââ 
SaveChangesAsync
ââ )
(
ââ) *
)
ââ* +
;
ââ+ ,
logger
ãã 
.
ãã 
LogInformation
ãã 
(
ãã 
$str
ãã _
,
ãã_ `
userId
ããa g
)
ããg h
;
ããh i
}
åå 
public
èè 

async
èè 
Task
èè 
RejectUserAsync
èè %
(
èè% &
int
èè& )
userId
èè* 0
,
èè0 1
string
èè2 8
?
èè8 9
reason
èè: @
=
èèA B
null
èèC G
)
èèG H
{
êê 
logger
ëë 
.
ëë 
LogInformation
ëë 
(
ëë 
$str
ëë l
,
ëël m
userId
íí 
,
íí 
reason
íí 
??
íí 
$str
íí 2
)
íí2 3
;
íí3 4
var
îî 
user
îî 
=
îî 
await
îî 

unitOfWork
îî #
.
îî# $
Users
îî$ )
.
îî) *
GetByIdAsync
îî* 6
(
îî6 7
userId
îî7 =
)
îî= >
;
îî> ?
if
ïï 

(
ïï 
user
ïï 
==
ïï 
null
ïï 
)
ïï 
{
ññ 	
logger
óó 
.
óó 

LogWarning
óó 
(
óó 
$str
óó U
,
óóU V
userId
óóW ]
)
óó] ^
;
óó^ _
throw
òò 
new
òò "
KeyNotFoundException
òò *
(
òò* +
$"
òò+ -
$str
òò- 2
{
òò2 3
userId
òò3 9
}
òò9 :
$str
òò: D
"
òòD E
)
òòE F
;
òòF G
}
ôô 	
user
õõ 
.
õõ 
Status
õõ 
=
õõ 

UserStatus
õõ  
.
õõ  !
Rejected
õõ! )
;
õõ) *

unitOfWork
úú 
.
úú 
Users
úú 
.
úú 
Update
úú 
(
úú  
user
úú  $
)
úú$ %
;
úú% &
await
ùù 

unitOfWork
ùù 
.
ùù 
SaveChangesAsync
ùù )
(
ùù) *
)
ùù* +
;
ùù+ ,
logger
üü 
.
üü 
LogInformation
üü 
(
üü 
$str
üü p
,
üüp q
userId
†† 
,
†† 
reason
†† 
??
†† 
$str
†† 2
)
††2 3
;
††3 4
}
°° 
private
∂∂ 
string
∂∂ 
GenerateJwtToken
∂∂ #
(
∂∂# $
Bo
∂∂$ &
.
∂∂& '
Models
∂∂' -
.
∂∂- .
UserBo
∂∂. 4
user
∂∂5 9
)
∂∂9 :
{
∑∑ 
logger
∏∏ 
.
∏∏ 
LogInformation
∏∏ 
(
∏∏ 
$str
∏∏ O
,
∏∏O P
user
∏∏Q U
.
∏∏U V
Email
∏∏V [
)
∏∏[ \
;
∏∏\ ]
var
∫∫ 
	jwtConfig
∫∫ 
=
∫∫ 
configuration
∫∫ %
.
∫∫% &

GetSection
∫∫& 0
(
∫∫0 1
$str
∫∫1 6
)
∫∫6 7
;
∫∫7 8
var
ªª 
key
ªª 
=
ªª 
new
ªª "
SymmetricSecurityKey
ªª *
(
ªª* +
Encoding
ªª+ 3
.
ªª3 4
UTF8
ªª4 8
.
ªª8 9
GetBytes
ªª9 A
(
ªªA B
	jwtConfig
ªªB K
[
ªªK L
$str
ªªL Q
]
ªªQ R
!
ªªR S
)
ªªS T
)
ªªT U
;
ªªU V
var
ºº 
creds
ºº 
=
ºº 
new
ºº  
SigningCredentials
ºº *
(
ºº* +
key
ºº+ .
,
ºº. / 
SecurityAlgorithms
ºº0 B
.
ººB C

HmacSha256
ººC M
)
ººM N
;
ººN O
var
ææ 
claims
ææ 
=
ææ 
new
ææ 
List
ææ 
<
ææ 
Claim
ææ #
>
ææ# $
{
øø 	
new
¿¿ 
(
¿¿ %
JwtRegisteredClaimNames
¿¿ '
.
¿¿' (
Sub
¿¿( +
,
¿¿+ ,
user
¿¿- 1
.
¿¿1 2
Email
¿¿2 7
)
¿¿7 8
,
¿¿8 9
new
¡¡ 
(
¡¡ 
$str
¡¡ 
,
¡¡ 
user
¡¡ 
.
¡¡ 
Id
¡¡ !
.
¡¡! "
ToString
¡¡" *
(
¡¡* +
)
¡¡+ ,
)
¡¡, -
,
¡¡- .
new
¬¬ 
(
¬¬ 
$str
¬¬ 
,
¬¬ 
$"
¬¬ 
{
¬¬ 
user
¬¬ 
.
¬¬  
	FirstName
¬¬  )
}
¬¬) *
$str
¬¬* +
{
¬¬+ ,
user
¬¬, 0
.
¬¬0 1
LastName
¬¬1 9
}
¬¬9 :
"
¬¬: ;
)
¬¬; <
,
¬¬< =
new
√√ 
(
√√ 
$str
√√ 
,
√√ 
user
√√ #
.
√√# $
StudentType
√√$ /
)
√√/ 0
}
ƒƒ 	
;
ƒƒ	 

if
∆∆ 

(
∆∆ 
user
∆∆ 
.
∆∆ 
Role
∆∆ 
!=
∆∆ 
null
∆∆ 
)
∆∆ 
{
«« 	
claims
»» 
.
»» 
Add
»» 
(
»» 
new
»» 
Claim
»»  
(
»»  !

ClaimTypes
»»! +
.
»»+ ,
Role
»», 0
,
»»0 1
user
»»2 6
.
»»6 7
Role
»»7 ;
.
»»; <
Name
»»< @
)
»»@ A
)
»»A B
;
»»B C
claims
ÀÀ 
.
ÀÀ 
Add
ÀÀ 
(
ÀÀ 
new
ÀÀ 
Claim
ÀÀ  
(
ÀÀ  !
$str
ÀÀ! 2
,
ÀÀ2 3
user
ÀÀ4 8
.
ÀÀ8 9
Role
ÀÀ9 =
.
ÀÀ= >
CanCreateEvents
ÀÀ> M
.
ÀÀM N
ToString
ÀÀN V
(
ÀÀV W
)
ÀÀW X
)
ÀÀX Y
)
ÀÀY Z
;
ÀÀZ [
claims
ÃÃ 
.
ÃÃ 
Add
ÃÃ 
(
ÃÃ 
new
ÃÃ 
Claim
ÃÃ  
(
ÃÃ  !
$str
ÃÃ! 2
,
ÃÃ2 3
user
ÃÃ4 8
.
ÃÃ8 9
Role
ÃÃ9 =
.
ÃÃ= >
CanModifyEvents
ÃÃ> M
.
ÃÃM N
ToString
ÃÃN V
(
ÃÃV W
)
ÃÃW X
)
ÃÃX Y
)
ÃÃY Z
;
ÃÃZ [
claims
ÕÕ 
.
ÕÕ 
Add
ÕÕ 
(
ÕÕ 
new
ÕÕ 
Claim
ÕÕ  
(
ÕÕ  !
$str
ÕÕ! 2
,
ÕÕ2 3
user
ÕÕ4 8
.
ÕÕ8 9
Role
ÕÕ9 =
.
ÕÕ= >
CanDeleteEvents
ÕÕ> M
.
ÕÕM N
ToString
ÕÕN V
(
ÕÕV W
)
ÕÕW X
)
ÕÕX Y
)
ÕÕY Z
;
ÕÕZ [
claims
œœ 
.
œœ 
Add
œœ 
(
œœ 
new
œœ 
Claim
œœ  
(
œœ  !
$str
œœ! 1
,
œœ1 2
user
œœ3 7
.
œœ7 8
Role
œœ8 <
.
œœ< =
CanCreateUsers
œœ= K
.
œœK L
ToString
œœL T
(
œœT U
)
œœU V
)
œœV W
)
œœW X
;
œœX Y
claims
–– 
.
–– 
Add
–– 
(
–– 
new
–– 
Claim
––  
(
––  !
$str
––! 1
,
––1 2
user
––3 7
.
––7 8
Role
––8 <
.
––< =
CanModifyUsers
––= K
.
––K L
ToString
––L T
(
––T U
)
––U V
)
––V W
)
––W X
;
––X Y
claims
—— 
.
—— 
Add
—— 
(
—— 
new
—— 
Claim
——  
(
——  !
$str
——! 1
,
——1 2
user
——3 7
.
——7 8
Role
——8 <
.
——< =
CanDeleteUsers
——= K
.
——K L
ToString
——L T
(
——T U
)
——U V
)
——V W
)
——W X
;
——X Y
}
““ 	
var
‘‘ 
token
‘‘ 
=
‘‘ 
new
‘‘ 
JwtSecurityToken
‘‘ (
(
‘‘( )
issuer
’’ 
:
’’ 
	jwtConfig
’’ 
[
’’ 
$str
’’ &
]
’’& '
,
’’' (
audience
÷÷ 
:
÷÷ 
	jwtConfig
÷÷ 
[
÷÷  
$str
÷÷  *
]
÷÷* +
,
÷÷+ ,
claims
◊◊ 
:
◊◊ 
claims
◊◊ 
,
◊◊ 
expires
ÿÿ 
:
ÿÿ 
DateTime
ÿÿ 
.
ÿÿ 
UtcNow
ÿÿ $
.
ÿÿ$ %

AddMinutes
ÿÿ% /
(
ÿÿ/ 0
Convert
ÿÿ0 7
.
ÿÿ7 8
ToDouble
ÿÿ8 @
(
ÿÿ@ A
	jwtConfig
ÿÿA J
[
ÿÿJ K
$str
ÿÿK Z
]
ÿÿZ [
)
ÿÿ[ \
)
ÿÿ\ ]
,
ÿÿ] ^ 
signingCredentials
ŸŸ 
:
ŸŸ 
creds
ŸŸ  %
)
⁄⁄ 	
;
⁄⁄	 

return
‹‹ 
new
‹‹ %
JwtSecurityTokenHandler
‹‹ *
(
‹‹* +
)
‹‹+ ,
.
‹‹, -

WriteToken
‹‹- 7
(
‹‹7 8
token
‹‹8 =
)
‹‹= >
;
‹‹> ?
}
›› 
}ﬂﬂ Ó¬
MC:\Users\micha\Projects\ESN-WebApi\Business\Proposition\PropositionService.cs
	namespace		 	
Business		
 
.		 
Proposition		 
;		 
public 
class 
PropositionService 
(  
IUnitOfWork  +

unitOfWork, 6
,6 7
IMapper8 ?
mapper@ F
,F G
ILoggerH O
<O P
PropositionServiceP b
>b c
loggerd j
)j k
: 
IPropositionService 
{ 
[ 
Obsolete 
( 
$str }
)} ~
]~ 
public 

async 
Task 
< 
IEnumerable !
<! "
PropositionDto" 0
>0 1
>1 2#
GetAllPropositionsAsync3 J
(J K
)K L
{ 
logger 
. 
LogInformation 
( 
$str n
)n o
;o p
var 
propositions 
= 
await  

unitOfWork! +
.+ ,
Propositions, 8
.8 9.
"GetAllPropositionsWithDetailsAsync9 [
([ \
)\ ]
;] ^
logger 
. 
LogInformation 
( 
$str t
,t u
propositions	v Ç
.
Ç É
Count
É à
(
à â
)
â ä
)
ä ã
;
ã å
return 
mapper 
. 
Map 
< 
IEnumerable %
<% &
PropositionDto& 4
>4 5
>5 6
(6 7
propositions7 C
)C D
;D E
} 
public 

async 
Task 
< 
PagedResult !
<! "
PropositionDto" 0
>0 1
>1 2#
GetAllPropositionsAsync3 J
(J K
PaginationParamsK [

pagination\ f
,f g
stringh n
?n o
	userEmailp y
=z {
null	| Ä
)
Ä Å
{   
logger!! 
.!! 
LogInformation!! 
(!! 
$str	!! ö
,
!!ö õ

pagination"" 
."" 

PageNumber"" !
,""! "

pagination""# -
.""- .
PageSize"". 6
,""6 7
	userEmail""8 A
??""B D
$str""E P
)""P Q
;""Q R
var$$ 
($$ 
items$$ 
,$$ 

totalCount$$ 
)$$ 
=$$  !
await$$" '

unitOfWork$$( 2
.$$2 3
Propositions$$3 ?
.$$? @
GetPagedAsync$$@ M
($$M N

pagination%% 
.%% 
Skip%% 
,%% 

pagination&& 
.&& 
PageSize&& 
)&&  
;&&  !
var(( 
dtos(( 
=(( 
mapper(( 
.(( 
Map(( 
<(( 
List(( "
<((" #
PropositionDto((# 1
>((1 2
>((2 3
(((3 4
items((4 9
)((9 :
;((: ;
if++ 

(++ 
!++ 
string++ 
.++ 
IsNullOrEmpty++ !
(++! "
	userEmail++" +
)+++ ,
)++, -
{,, 	
var-- 
user-- 
=-- 
await-- 

unitOfWork-- '
.--' (
Users--( -
.--- .
GetByEmailAsync--. =
(--= >
	userEmail--> G
)--G H
;--H I
if.. 
(.. 
user.. 
!=.. 
null.. 
).. 
{// 
var11 
propositionIds11 "
=11# $
dtos11% )
.11) *
Select11* 0
(110 1
p111 2
=>113 5
p116 7
.117 8
Id118 :
)11: ;
.11; <
ToList11< B
(11B C
)11C D
;11D E
var22 
	userVotes22 
=22 
await22  %

unitOfWork22& 0
.220 1
PropositionVotes221 A
.22A B,
 GetUserVotesForPropositionsAsync22B b
(22b c
user22c g
.22g h
Id22h j
,22j k
propositionIds22l z
)22z {
;22{ |
foreach55 
(55 
var55 
dto55  
in55! #
dtos55$ (
)55( )
{66 
var77 
vote77 
=77 
	userVotes77 (
.77( )
FirstOrDefault77) 7
(777 8
v778 9
=>77: <
v77= >
.77> ?
PropositionId77? L
==77M O
dto77P S
.77S T
Id77T V
)77V W
;77W X
dto88 
.88 
UserVoteType88 $
=88% &
vote88' +
!=88, .
null88/ 3
?884 5 
ConvertVoteTypeToDto886 J
(88J K
vote88K O
.88O P
VoteType88P X
)88X Y
:88Z [
null88\ `
;88` a
}99 
}:: 
};; 	
logger== 
.== 
LogInformation== 
(== 
$str	== É
,
==É Ñ
dtos>> 
.>> 
Count>> 
,>> 

totalCount>> "
)>>" #
;>># $
return@@ 
new@@ 
PagedResult@@ 
<@@ 
PropositionDto@@ -
>@@- .
(@@. /
dtos@@/ 3
,@@3 4

totalCount@@5 ?
,@@? @

pagination@@A K
.@@K L

PageNumber@@L V
,@@V W

pagination@@X b
.@@b c
PageSize@@c k
)@@k l
;@@l m
}AA 
publicDD 

asyncDD 
TaskDD 
<DD 
PropositionDtoDD $
?DD$ %
>DD% &#
GetPropositionByIdAsyncDD' >
(DD> ?
intDD? B
idDDC E
,DDE F
stringDDG M
?DDM N
	userEmailDDO X
=DDY Z
nullDD[ _
)DD_ `
{EE 
loggerFF 
.FF 
LogInformationFF 
(FF 
$str	FF Ä
,
FFÄ Å
idGG 
,GG 
	userEmailGG 
??GG 
$strGG (
)GG( )
;GG) *
varII 
propositionII 
=II 
awaitII 

unitOfWorkII  *
.II* +
PropositionsII+ 7
.II7 8*
GetPropositionWithDetailsAsyncII8 V
(IIV W
idIIW Y
)IIY Z
;IIZ [
ifKK 

(KK 
propositionKK 
==KK 
nullKK 
)KK  
{LL 	
loggerMM 
.MM 

LogWarningMM 
(MM 
$strMM g
,MMg h
idMMi k
)MMk l
;MMl m
returnNN 
nullNN 
;NN 
}OO 	
varQQ 
dtoQQ 
=QQ 
mapperQQ 
.QQ 
MapQQ 
<QQ 
PropositionDtoQQ +
>QQ+ ,
(QQ, -
propositionQQ- 8
)QQ8 9
;QQ9 :
ifTT 

(TT 
!TT 
stringTT 
.TT 
IsNullOrEmptyTT !
(TT! "
	userEmailTT" +
)TT+ ,
)TT, -
{UU 	
varVV 
userVV 
=VV 
awaitVV 

unitOfWorkVV '
.VV' (
UsersVV( -
.VV- .
GetByEmailAsyncVV. =
(VV= >
	userEmailVV> G
)VVG H
;VVH I
ifWW 
(WW 
userWW 
!=WW 
nullWW 
)WW 
{XX 
varYY 
userVoteYY 
=YY 
awaitYY $

unitOfWorkYY% /
.YY/ 0
PropositionVotesYY0 @
.YY@ A(
GetByPropositionAndUserAsyncYYA ]
(YY] ^
idYY^ `
,YY` a
userYYb f
.YYf g
IdYYg i
)YYi j
;YYj k
dtoZZ 
.ZZ 
UserVoteTypeZZ  
=ZZ! "
userVoteZZ# +
!=ZZ, .
nullZZ/ 3
?ZZ4 5 
ConvertVoteTypeToDtoZZ6 J
(ZZJ K
userVoteZZK S
.ZZS T
VoteTypeZZT \
)ZZ\ ]
:ZZ^ _
nullZZ` d
;ZZd e
}[[ 
}\\ 	
logger^^ 
.^^ 
LogInformation^^ 
(^^ 
$str^^ k
,^^k l
id^^m o
)^^o p
;^^p q
return`` 
dto`` 
;`` 
}aa 
publicdd 

asyncdd 
Taskdd 
<dd 
PropositionDtodd $
>dd$ %"
CreatePropositionAsyncdd& <
(dd< =
PropositionDtodd= K
propositionDtoddL Z
,ddZ [
stringdd\ b
	userEmailddc l
)ddl m
{ee 
loggerff 
.ff 
LogInformationff 
(ff 
$strff n
,ffn o
propositionDtogg 
.gg 
Titlegg  
,gg  !
	userEmailgg" +
)gg+ ,
;gg, -
varii 
userii 
=ii 
awaitii 

unitOfWorkii #
.ii# $
Usersii$ )
.ii) *
GetByEmailAsyncii* 9
(ii9 :
	userEmailii: C
)iiC D
;iiD E
ifjj 

(jj 
userjj 
==jj 
nulljj 
)jj 
{kk 	
loggerll 
.ll 
LogErrorll 
(ll 
$strll k
,llk l
	userEmailllm v
)llv w
;llw x
throwmm 
newmm '
UnauthorizedAccessExceptionmm 1
(mm1 2
$"mm2 4
$strmm4 D
{mmD E
	userEmailmmE N
}mmN O
"mmO P
)mmP Q
;mmQ R
}nn 	
varpp 
propositionpp 
=pp 
mapperpp  
.pp  !
Mappp! $
<pp$ %
Bopp% '
.pp' (
Modelspp( .
.pp. /
PropositionBopp/ <
>pp< =
(pp= >
propositionDtopp> L
)ppL M
;ppM N
propositionqq 
.qq 
	CreatedAtqq 
=qq 
DateTimeqq  (
.qq( )
UtcNowqq) /
;qq/ 0
propositionrr 
.rr 
	IsDeletedrr 
=rr 
falserr  %
;rr% &
propositionss 
.ss 
UserIdss 
=ss 
userss !
.ss! "
Idss" $
;ss$ %
awaituu 

unitOfWorkuu 
.uu 
Propositionsuu %
.uu% &
AddAsyncuu& .
(uu. /
propositionuu/ :
)uu: ;
;uu; <
awaitvv 

unitOfWorkvv 
.vv 
SaveChangesAsyncvv )
(vv) *
)vv* +
;vv+ ,
loggerxx 
.xx 
LogInformationxx 
(xx 
$strxx j
,xxj k
propositionyy 
.yy 
Titleyy 
,yy 
useryy #
.yy# $
Emailyy$ )
)yy) *
;yy* +
return{{ 
mapper{{ 
.{{ 
Map{{ 
<{{ 
PropositionDto{{ (
>{{( )
({{) *
proposition{{* 5
){{5 6
;{{6 7
}|| 
public 

async 
Task 
< 
PropositionDto $
?$ %
>% &"
UpdatePropositionAsync' =
(= >
int> A
idB D
,D E
PropositionDtoF T
propositionDtoU c
,c d
stringe k
	userEmaill u
)u v
{
ÄÄ 
logger
ÅÅ 
.
ÅÅ 
LogInformation
ÅÅ 
(
ÅÅ 
$strÅÅ Ö
,ÅÅÖ Ü
id
ÇÇ 
,
ÇÇ 
propositionDto
ÇÇ 
.
ÇÇ 
Title
ÇÇ $
,
ÇÇ$ %
	userEmail
ÇÇ& /
)
ÇÇ/ 0
;
ÇÇ0 1
var
ÑÑ 
existing
ÑÑ 
=
ÑÑ 
await
ÑÑ 

unitOfWork
ÑÑ '
.
ÑÑ' (
Propositions
ÑÑ( 4
.
ÑÑ4 5
GetByIdAsync
ÑÑ5 A
(
ÑÑA B
id
ÑÑB D
)
ÑÑD E
;
ÑÑE F
if
ÖÖ 

(
ÖÖ 
existing
ÖÖ 
==
ÖÖ 
null
ÖÖ 
||
ÖÖ 
existing
ÖÖ  (
.
ÖÖ( )
	IsDeleted
ÖÖ) 2
)
ÖÖ2 3
{
ÜÜ 	
logger
áá 
.
áá 

LogWarning
áá 
(
áá 
$str
áá f
,
ááf g
id
ááh j
)
ááj k
;
áák l
return
àà 
null
àà 
;
àà 
}
ââ 	
var
åå 
user
åå 
=
åå 
await
åå 

unitOfWork
åå #
.
åå# $
Users
åå$ )
.
åå) *
GetByEmailAsync
åå* 9
(
åå9 :
	userEmail
åå: C
)
ååC D
;
ååD E
if
çç 

(
çç 
user
çç 
==
çç 
null
çç 
)
çç 
{
éé 	
logger
èè 
.
èè 
LogError
èè 
(
èè 
$str
èè d
,
èèd e
	userEmail
èèf o
)
èèo p
;
èèp q
throw
êê 
new
êê )
UnauthorizedAccessException
êê 1
(
êê1 2
$"
êê2 4
$str
êê4 D
{
êêD E
	userEmail
êêE N
}
êêN O
"
êêO P
)
êêP Q
;
êêQ R
}
ëë 	
if
îî 

(
îî 
existing
îî 
.
îî 
UserId
îî 
!=
îî 
user
îî #
.
îî# $
Id
îî$ &
)
îî& '
{
ïï 	
logger
ññ 
.
ññ 

LogWarning
ññ 
(
ññ 
$strññ ¢
,ññ¢ £
	userEmail
óó 
,
óó 
user
óó 
.
óó  
Id
óó  "
,
óó" #
id
óó$ &
,
óó& '
existing
óó( 0
.
óó0 1
UserId
óó1 7
)
óó7 8
;
óó8 9
throw
òò 
new
òò )
UnauthorizedAccessException
òò 1
(
òò1 2
$str
òò2 h
)
òòh i
;
òòi j
}
ôô 	
mapper
õõ 
.
õõ 
Map
õõ 
(
õõ 
propositionDto
õõ !
,
õõ! "
existing
õõ# +
)
õõ+ ,
;
õõ, -
existing
úú 
.
úú 

ModifiedAt
úú 
=
úú 
DateTime
úú &
.
úú& '
UtcNow
úú' -
;
úú- .
try
ûû 
{
üü 	

unitOfWork
†† 
.
†† 
Propositions
†† #
.
††# $
Update
††$ *
(
††* +
existing
††+ 3
)
††3 4
;
††4 5
await
°° 

unitOfWork
°° 
.
°° 
SaveChangesAsync
°° -
(
°°- .
)
°°. /
;
°°/ 0
logger
¢¢ 
.
¢¢ 
LogInformation
¢¢ !
(
¢¢! "
$str
¢¢" u
,
¢¢u v
id
¢¢w y
)
¢¢y z
;
¢¢z {
}
££ 	
catch
§§ 
(
§§ 
	Exception
§§ 
ex
§§ 
)
§§ 
{
•• 	
if
¶¶ 
(
¶¶ 
!
¶¶ 
await
¶¶ 

unitOfWork
¶¶ !
.
¶¶! "
Propositions
¶¶" .
.
¶¶. /
AnyAsync
¶¶/ 7
(
¶¶7 8
e
¶¶8 9
=>
¶¶: <
e
¶¶= >
.
¶¶> ?
Id
¶¶? A
==
¶¶B D
id
¶¶E G
)
¶¶G H
)
¶¶H I
{
ßß 
logger
®® 
.
®® 

LogWarning
®® !
(
®®! "
$str®®" å
,®®å ç
id®®é ê
)®®ê ë
;®®ë í
return
©© 
null
©© 
;
©© 
}
™™ 
logger
´´ 
.
´´ 
LogError
´´ 
(
´´ 
ex
´´ 
,
´´ 
$str
´´  z
,
´´z {
id
´´| ~
)
´´~ 
;´´ Ä
throw
¨¨ 
;
¨¨ 
}
≠≠ 	
logger
ØØ 
.
ØØ 
LogInformation
ØØ 
(
ØØ 
$str
ØØ j
,
ØØj k
id
ØØl n
)
ØØn o
;
ØØo p
return
±± 
mapper
±± 
.
±± 
Map
±± 
<
±± 
PropositionDto
±± (
>
±±( )
(
±±) *
existing
±±* 2
)
±±2 3
;
±±3 4
}
≤≤ 
public
µµ 

async
µµ 
Task
µµ 
<
µµ 
PropositionDto
µµ $
?
µµ$ %
>
µµ% &$
DeletePropositionAsync
µµ' =
(
µµ= >
int
µµ> A
id
µµB D
,
µµD E
string
µµF L
	userEmail
µµM V
)
µµV W
{
∂∂ 
logger
∑∑ 
.
∑∑ 
LogInformation
∑∑ 
(
∑∑ 
$str
∑∑ r
,
∑∑r s
id
∑∑t v
,
∑∑v w
	userEmail∑∑x Å
)∑∑Å Ç
;∑∑Ç É
var
ππ 
proposition
ππ 
=
ππ 
await
ππ 

unitOfWork
ππ  *
.
ππ* +
Propositions
ππ+ 7
.
ππ7 8
GetByIdAsync
ππ8 D
(
ππD E
id
ππE G
)
ππG H
;
ππH I
if
∫∫ 

(
∫∫ 
proposition
∫∫ 
==
∫∫ 
null
∫∫ 
||
∫∫  "
proposition
∫∫# .
.
∫∫. /
	IsDeleted
∫∫/ 8
)
∫∫8 9
{
ªª 	
logger
ºº 
.
ºº 

LogWarning
ºº 
(
ºº 
$str
ºº f
,
ººf g
id
ººh j
)
ººj k
;
ººk l
return
ΩΩ 
null
ΩΩ 
;
ΩΩ 
}
ææ 	
var
¡¡ 
user
¡¡ 
=
¡¡ 
await
¡¡ 

unitOfWork
¡¡ #
.
¡¡# $
Users
¡¡$ )
.
¡¡) *
GetByEmailAsync
¡¡* 9
(
¡¡9 :
	userEmail
¡¡: C
)
¡¡C D
;
¡¡D E
if
¬¬ 

(
¬¬ 
user
¬¬ 
==
¬¬ 
null
¬¬ 
)
¬¬ 
{
√√ 	
logger
ƒƒ 
.
ƒƒ 
LogError
ƒƒ 
(
ƒƒ 
$str
ƒƒ d
,
ƒƒd e
	userEmail
ƒƒf o
)
ƒƒo p
;
ƒƒp q
throw
≈≈ 
new
≈≈ )
UnauthorizedAccessException
≈≈ 1
(
≈≈1 2
$"
≈≈2 4
$str
≈≈4 D
{
≈≈D E
	userEmail
≈≈E N
}
≈≈N O
"
≈≈O P
)
≈≈P Q
;
≈≈Q R
}
∆∆ 	
bool
…… 
isOwner
…… 
=
…… 
proposition
…… "
.
……" #
UserId
……# )
==
……* ,
user
……- 1
.
……1 2
Id
……2 4
;
……4 5
bool
   
isEsnMember
   
=
   
user
   
.
    
StudentType
    +
?
  + ,
.
  , -
ToLower
  - 4
(
  4 5
)
  5 6
==
  7 9
$str
  : F
;
  F G
bool
ÀÀ 
isAdmin
ÀÀ 
=
ÀÀ 
user
ÀÀ 
.
ÀÀ 
Role
ÀÀ  
?
ÀÀ  !
.
ÀÀ! "
Name
ÀÀ" &
==
ÀÀ' )
UserRole
ÀÀ* 2
.
ÀÀ2 3
Admin
ÀÀ3 8
;
ÀÀ8 9
if
ÕÕ 

(
ÕÕ 
!
ÕÕ 
isOwner
ÕÕ 
&&
ÕÕ 
!
ÕÕ 
isEsnMember
ÕÕ $
&&
ÕÕ% '
!
ÕÕ( )
isAdmin
ÕÕ) 0
)
ÕÕ0 1
{
ŒŒ 	
logger
œœ 
.
œœ 

LogWarning
œœ 
(
œœ 
$strœœ ¢
,œœ¢ £
	userEmail
–– 
,
–– 
user
–– 
.
––  
Id
––  "
,
––" #
id
––$ &
,
––& '
proposition
––( 3
.
––3 4
UserId
––4 :
)
––: ;
;
––; <
throw
—— 
new
—— )
UnauthorizedAccessException
—— 1
(
——1 2
$str
——2 h
)
——h i
;
——i j
}
““ 	
proposition
’’ 
.
’’ 
	IsDeleted
’’ 
=
’’ 
true
’’  $
;
’’$ %
proposition
÷÷ 
.
÷÷ 
	DeletedAt
÷÷ 
=
÷÷ 
DateTime
÷÷  (
.
÷÷( )
UtcNow
÷÷) /
;
÷÷/ 0

unitOfWork
ÿÿ 
.
ÿÿ 
Propositions
ÿÿ 
.
ÿÿ  
Update
ÿÿ  &
(
ÿÿ& '
proposition
ÿÿ' 2
)
ÿÿ2 3
;
ÿÿ3 4
await
ŸŸ 

unitOfWork
ŸŸ 
.
ŸŸ 
SaveChangesAsync
ŸŸ )
(
ŸŸ) *
)
ŸŸ* +
;
ŸŸ+ ,
logger
€€ 
.
€€ 
LogInformation
€€ 
(
€€ 
$str
€€ j
,
€€j k
id
€€l n
)
€€n o
;
€€o p
return
›› 
mapper
›› 
.
›› 
Map
›› 
<
›› 
PropositionDto
›› (
>
››( )
(
››) *
proposition
››* 5
)
››5 6
;
››6 7
}
ﬁﬁ 
public
·· 

async
·· 
Task
·· 
<
·· 
PropositionDto
·· $
?
··$ %
>
··% &
VoteUpAsync
··' 2
(
··2 3
int
··3 6
id
··7 9
,
··9 :
string
··; A
	userEmail
··B K
)
··K L
=>
‚‚ 

await
‚‚ 
	VoteAsync
‚‚ 
(
‚‚ 
id
‚‚ 
,
‚‚ 
	userEmail
‚‚ (
,
‚‚( )
Bo
‚‚* ,
.
‚‚, -
Models
‚‚- 3
.
‚‚3 4
VoteType
‚‚4 <
.
‚‚< =
Up
‚‚= ?
)
‚‚? @
;
‚‚@ A
public
ÂÂ 

async
ÂÂ 
Task
ÂÂ 
<
ÂÂ 
PropositionDto
ÂÂ $
?
ÂÂ$ %
>
ÂÂ% &
VoteDownAsync
ÂÂ' 4
(
ÂÂ4 5
int
ÂÂ5 8
id
ÂÂ9 ;
,
ÂÂ; <
string
ÂÂ= C
	userEmail
ÂÂD M
)
ÂÂM N
=>
ÊÊ 

await
ÊÊ 
	VoteAsync
ÊÊ 
(
ÊÊ 
id
ÊÊ 
,
ÊÊ 
	userEmail
ÊÊ (
,
ÊÊ( )
Bo
ÊÊ* ,
.
ÊÊ, -
Models
ÊÊ- 3
.
ÊÊ3 4
VoteType
ÊÊ4 <
.
ÊÊ< =
Down
ÊÊ= A
)
ÊÊA B
;
ÊÊB C
private
ËË 
async
ËË 
Task
ËË 
<
ËË 
PropositionDto
ËË %
?
ËË% &
>
ËË& '
	VoteAsync
ËË( 1
(
ËË1 2
int
ËË2 5
id
ËË6 8
,
ËË8 9
string
ËË: @
	userEmail
ËËA J
,
ËËJ K
Bo
ËËL N
.
ËËN O
Models
ËËO U
.
ËËU V
VoteType
ËËV ^
voteType
ËË_ g
)
ËËg h
{
ÈÈ 
logger
ÍÍ 
.
ÍÍ 
LogInformation
ÍÍ 
(
ÍÍ 
$str
ÍÍ u
,
ÍÍu v
id
ÎÎ 
,
ÎÎ 
	userEmail
ÎÎ 
,
ÎÎ 
voteType
ÎÎ #
)
ÎÎ# $
;
ÎÎ$ %
var
ÌÌ 
user
ÌÌ 
=
ÌÌ 
await
ÌÌ 

unitOfWork
ÌÌ #
.
ÌÌ# $
Users
ÌÌ$ )
.
ÌÌ) *
GetByEmailAsync
ÌÌ* 9
(
ÌÌ9 :
	userEmail
ÌÌ: C
)
ÌÌC D
;
ÌÌD E
if
ÓÓ 

(
ÓÓ 
user
ÓÓ 
==
ÓÓ 
null
ÓÓ 
)
ÓÓ 
{
ÔÔ 	
logger
 
.
 
LogError
 
(
 
$str
 ^
,
^ _
	userEmail
` i
)
i j
;
j k
throw
ÒÒ 
new
ÒÒ )
UnauthorizedAccessException
ÒÒ 1
(
ÒÒ1 2
$"
ÒÒ2 4
$str
ÒÒ4 D
{
ÒÒD E
	userEmail
ÒÒE N
}
ÒÒN O
"
ÒÒO P
)
ÒÒP Q
;
ÒÒQ R
}
ÚÚ 	
var
ÙÙ 
proposition
ÙÙ 
=
ÙÙ 
await
ÙÙ 

unitOfWork
ÙÙ  *
.
ÙÙ* +
Propositions
ÙÙ+ 7
.
ÙÙ7 8
GetByIdAsync
ÙÙ8 D
(
ÙÙD E
id
ÙÙE G
)
ÙÙG H
;
ÙÙH I
if
ıı 

(
ıı 
proposition
ıı 
==
ıı 
null
ıı 
||
ıı  "
proposition
ıı# .
.
ıı. /
	IsDeleted
ıı/ 8
)
ıı8 9
{
ˆˆ 	
logger
˜˜ 
.
˜˜ 

LogWarning
˜˜ 
(
˜˜ 
$str
˜˜ Y
,
˜˜Y Z
id
˜˜[ ]
)
˜˜] ^
;
˜˜^ _
return
¯¯ 
null
¯¯ 
;
¯¯ 
}
˘˘ 	
var
¸¸ 
existingVote
¸¸ 
=
¸¸ 
await
¸¸  

unitOfWork
¸¸! +
.
¸¸+ ,
PropositionVotes
¸¸, <
.
¸¸< =*
GetByPropositionAndUserAsync
¸¸= Y
(
¸¸Y Z
id
¸¸Z \
,
¸¸\ ]
user
¸¸^ b
.
¸¸b c
Id
¸¸c e
)
¸¸e f
;
¸¸f g
if
˛˛ 

(
˛˛ 
existingVote
˛˛ 
!=
˛˛ 
null
˛˛  
)
˛˛  !
{
ˇˇ 	
if
ÅÅ 
(
ÅÅ 
existingVote
ÅÅ 
.
ÅÅ 
VoteType
ÅÅ %
==
ÅÅ& (
voteType
ÅÅ) 1
)
ÅÅ1 2
{
ÇÇ 
logger
ÉÉ 
.
ÉÉ 
LogInformation
ÉÉ %
(
ÉÉ% &
$str
ÉÉ& a
,
ÉÉa b
	userEmail
ÑÑ 
,
ÑÑ 
voteType
ÑÑ '
,
ÑÑ' (
id
ÑÑ) +
)
ÑÑ+ ,
;
ÑÑ, -

unitOfWork
ÖÖ 
.
ÖÖ 
PropositionVotes
ÖÖ +
.
ÖÖ+ ,
Delete
ÖÖ, 2
(
ÖÖ2 3
existingVote
ÖÖ3 ?
)
ÖÖ? @
;
ÖÖ@ A
}
ÜÜ 
else
áá 
{
àà 
logger
ää 
.
ää 
LogInformation
ää %
(
ää% &
$str
ää& r
,
äär s
	userEmail
ãã 
,
ãã 
existingVote
ãã +
.
ãã+ ,
VoteType
ãã, 4
,
ãã4 5
voteType
ãã6 >
,
ãã> ?
id
ãã@ B
)
ããB C
;
ããC D
existingVote
åå 
.
åå 
VoteType
åå %
=
åå& '
voteType
åå( 0
;
åå0 1
existingVote
çç 
.
çç 
	UpdatedAt
çç &
=
çç' (
DateTime
çç) 1
.
çç1 2
UtcNow
çç2 8
;
çç8 9

unitOfWork
éé 
.
éé 
PropositionVotes
éé +
.
éé+ ,
Update
éé, 2
(
éé2 3
existingVote
éé3 ?
)
éé? @
;
éé@ A
}
èè 
}
êê 	
else
ëë 
{
íí 	
logger
îî 
.
îî 
LogInformation
îî !
(
îî! "
$str
îî" _
,
îî_ `
	userEmail
ïï 
,
ïï 
voteType
ïï #
,
ïï# $
id
ïï% '
)
ïï' (
;
ïï( )
var
ññ 
newVote
ññ 
=
ññ 
new
ññ 
Bo
ññ  
.
ññ  !
Models
ññ! '
.
ññ' (
PropositionVoteBo
ññ( 9
{
óó 
PropositionId
òò 
=
òò 
id
òò  "
,
òò" #
UserId
ôô 
=
ôô 
user
ôô 
.
ôô 
Id
ôô  
,
ôô  !
VoteType
öö 
=
öö 
voteType
öö #
,
öö# $
	CreatedAt
õõ 
=
õõ 
DateTime
õõ $
.
õõ$ %
UtcNow
õõ% +
}
úú 
;
úú 
await
ùù 

unitOfWork
ùù 
.
ùù 
PropositionVotes
ùù -
.
ùù- .
AddAsync
ùù. 6
(
ùù6 7
newVote
ùù7 >
)
ùù> ?
;
ùù? @
}
ûû 	
await
°° 

unitOfWork
°° 
.
°° 
SaveChangesAsync
°° )
(
°°) *
)
°°* +
;
°°+ ,
proposition
§§ 
.
§§ 
VotesUp
§§ 
=
§§ 
await
§§ #

unitOfWork
§§$ .
.
§§. /
PropositionVotes
§§/ ?
.
§§? @
CountUpVotesAsync
§§@ Q
(
§§Q R
id
§§R T
)
§§T U
;
§§U V
proposition
•• 
.
•• 
	VotesDown
•• 
=
•• 
await
••  %

unitOfWork
••& 0
.
••0 1
PropositionVotes
••1 A
.
••A B!
CountDownVotesAsync
••B U
(
••U V
id
••V X
)
••X Y
;
••Y Z
proposition
ßß 
.
ßß 

ModifiedAt
ßß 
=
ßß  
DateTime
ßß! )
.
ßß) *
UtcNow
ßß* 0
;
ßß0 1

unitOfWork
®® 
.
®® 
Propositions
®® 
.
®®  
Update
®®  &
(
®®& '
proposition
®®' 2
)
®®2 3
;
®®3 4
await
©© 

unitOfWork
©© 
.
©© 
SaveChangesAsync
©© )
(
©©) *
)
©©* +
;
©©+ ,
logger
´´ 
.
´´ 
LogInformation
´´ 
(
´´ 
$str´´ â
,´´â ä
id
¨¨ 
,
¨¨ 
proposition
¨¨ 
.
¨¨ 
VotesUp
¨¨ #
,
¨¨# $
proposition
¨¨% 0
.
¨¨0 1
	VotesDown
¨¨1 :
)
¨¨: ;
;
¨¨; <
var
ÆÆ $
propositionWithDetails
ÆÆ "
=
ÆÆ# $
await
ÆÆ% *

unitOfWork
ÆÆ+ 5
.
ÆÆ5 6
Propositions
ÆÆ6 B
.
ÆÆB C,
GetPropositionWithDetailsAsync
ÆÆC a
(
ÆÆa b
id
ÆÆb d
)
ÆÆd e
;
ÆÆe f
var
ØØ 
dto
ØØ 
=
ØØ 
mapper
ØØ 
.
ØØ 
Map
ØØ 
<
ØØ 
PropositionDto
ØØ +
>
ØØ+ ,
(
ØØ, -$
propositionWithDetails
ØØ- C
)
ØØC D
;
ØØD E
var
≤≤ 
	finalVote
≤≤ 
=
≤≤ 
await
≤≤ 

unitOfWork
≤≤ (
.
≤≤( )
PropositionVotes
≤≤) 9
.
≤≤9 :*
GetByPropositionAndUserAsync
≤≤: V
(
≤≤V W
id
≤≤W Y
,
≤≤Y Z
user
≤≤[ _
.
≤≤_ `
Id
≤≤` b
)
≤≤b c
;
≤≤c d
dto
≥≥ 
.
≥≥ 
UserVoteType
≥≥ 
=
≥≥ 
	finalVote
≥≥ $
!=
≥≥% '
null
≥≥( ,
?
≥≥- ."
ConvertVoteTypeToDto
≥≥/ C
(
≥≥C D
	finalVote
≥≥D M
.
≥≥M N
VoteType
≥≥N V
)
≥≥V W
:
≥≥X Y
null
≥≥Z ^
;
≥≥^ _
return
µµ 
dto
µµ 
;
µµ 
}
∂∂ 
private
ªª 
static
ªª 
int
ªª "
ConvertVoteTypeToDto
ªª +
(
ªª+ ,
Bo
ªª, .
.
ªª. /
Models
ªª/ 5
.
ªª5 6
VoteType
ªª6 >
voteType
ªª? G
)
ªªG H
{
ºº 
return
ΩΩ 
voteType
ΩΩ 
==
ΩΩ 
Bo
ΩΩ 
.
ΩΩ 
Models
ΩΩ $
.
ΩΩ$ %
VoteType
ΩΩ% -
.
ΩΩ- .
Up
ΩΩ. 0
?
ΩΩ1 2
$num
ΩΩ3 4
:
ΩΩ5 6
-
ΩΩ7 8
$num
ΩΩ8 9
;
ΩΩ9 :
}
ææ 
public
¡¡ 

async
¡¡ 
Task
¡¡ 
<
¡¡ 
PagedResult
¡¡ !
<
¡¡! "
PropositionDto
¡¡" 0
>
¡¡0 1
>
¡¡1 2-
GetAllPropositionsForAdminAsync
¡¡3 R
(
¡¡R S
PaginationParams
¬¬ 

pagination
¬¬ #
,
¬¬# $
Dto
√√ 
.
√√ 
Proposition
√√ 
.
√√ "
PropositionFilterDto
√√ ,
filter
√√- 3
,
√√3 4
string
ƒƒ 
?
ƒƒ 
	userEmail
ƒƒ 
=
ƒƒ 
null
ƒƒ  
)
ƒƒ  !
{
≈≈ 
logger
∆∆ 
.
∆∆ 
LogInformation
∆∆ 
(
∆∆ 
$str
∆∆ n
,
∆∆n o
filter
∆∆p v
.
∆∆v w
Status
∆∆w }
)
∆∆} ~
;
∆∆~ 
var
…… 
skip
…… 
=
…… 
(
…… 

pagination
…… 
.
…… 

PageNumber
…… )
-
……* +
$num
……, -
)
……- .
*
……/ 0

pagination
……1 ;
.
……; <
PageSize
……< D
;
……D E
var
   
take
   
=
   

pagination
   
.
   
PageSize
   &
;
  & '
var
ÕÕ 
(
ÕÕ 
propositions
ÕÕ 
,
ÕÕ 

totalCount
ÕÕ %
)
ÕÕ% &
=
ÕÕ' (
await
ÕÕ) .

unitOfWork
ÕÕ/ 9
.
ÕÕ9 :
Propositions
ÕÕ: F
.
ÕÕF G%
GetPagedWithFilterAsync
ÕÕG ^
(
ÕÕ^ _
skip
ÕÕ_ c
,
ÕÕc d
take
ÕÕe i
,
ÕÕi j
filter
ÕÕk q
.
ÕÕq r
Status
ÕÕr x
)
ÕÕx y
;
ÕÕy z
var
–– 
propositionDtos
–– 
=
–– 
mapper
–– $
.
––$ %
Map
––% (
<
––( )
IEnumerable
––) 4
<
––4 5
PropositionDto
––5 C
>
––C D
>
––D E
(
––E F
propositions
––F R
)
––R S
.
––S T
ToList
––T Z
(
––Z [
)
––[ \
;
––\ ]
if
”” 

(
”” 
!
”” 
string
”” 
.
”” 
IsNullOrEmpty
”” !
(
””! "
	userEmail
””" +
)
””+ ,
)
””, -
{
‘‘ 	
var
’’ 
user
’’ 
=
’’ 
await
’’ 

unitOfWork
’’ '
.
’’' (
Users
’’( -
.
’’- .
GetByEmailAsync
’’. =
(
’’= >
	userEmail
’’> G
)
’’G H
;
’’H I
if
÷÷ 
(
÷÷ 
user
÷÷ 
!=
÷÷ 
null
÷÷ 
)
÷÷ 
{
◊◊ 
var
ŸŸ 
propositionIds
ŸŸ "
=
ŸŸ# $
propositionDtos
ŸŸ% 4
.
ŸŸ4 5
Select
ŸŸ5 ;
(
ŸŸ; <
p
ŸŸ< =
=>
ŸŸ> @
p
ŸŸA B
.
ŸŸB C
Id
ŸŸC E
)
ŸŸE F
.
ŸŸF G
ToList
ŸŸG M
(
ŸŸM N
)
ŸŸN O
;
ŸŸO P
var
⁄⁄ 
	userVotes
⁄⁄ 
=
⁄⁄ 
await
⁄⁄  %

unitOfWork
⁄⁄& 0
.
⁄⁄0 1
PropositionVotes
⁄⁄1 A
.
⁄⁄A B.
 GetUserVotesForPropositionsAsync
⁄⁄B b
(
⁄⁄b c
user
⁄⁄c g
.
⁄⁄g h
Id
⁄⁄h j
,
⁄⁄j k
propositionIds
⁄⁄l z
)
⁄⁄z {
;
⁄⁄{ |
foreach
›› 
(
›› 
var
›› 
dto
››  
in
››! #
propositionDtos
››$ 3
)
››3 4
{
ﬁﬁ 
var
ﬂﬂ 
vote
ﬂﬂ 
=
ﬂﬂ 
	userVotes
ﬂﬂ (
.
ﬂﬂ( )
FirstOrDefault
ﬂﬂ) 7
(
ﬂﬂ7 8
v
ﬂﬂ8 9
=>
ﬂﬂ: <
v
ﬂﬂ= >
.
ﬂﬂ> ?
PropositionId
ﬂﬂ? L
==
ﬂﬂM O
dto
ﬂﬂP S
.
ﬂﬂS T
Id
ﬂﬂT V
)
ﬂﬂV W
;
ﬂﬂW X
dto
‡‡ 
.
‡‡ 
UserVoteType
‡‡ $
=
‡‡% &
vote
‡‡' +
!=
‡‡, .
null
‡‡/ 3
?
‡‡4 5"
ConvertVoteTypeToDto
‡‡6 J
(
‡‡J K
vote
‡‡K O
.
‡‡O P
VoteType
‡‡P X
)
‡‡X Y
:
‡‡Z [
null
‡‡\ `
;
‡‡` a
}
·· 
}
‚‚ 
}
„„ 	
logger
ÂÂ 
.
ÂÂ 
LogInformation
ÂÂ 
(
ÂÂ 
$strÂÂ Å
,ÂÂÅ Ç
propositionDtos
ÊÊ 
.
ÊÊ 
Count
ÊÊ !
,
ÊÊ! "

totalCount
ÊÊ# -
)
ÊÊ- .
;
ÊÊ. /
return
ËË 
new
ËË 
PagedResult
ËË 
<
ËË 
PropositionDto
ËË -
>
ËË- .
(
ËË. /
propositionDtos
ÈÈ 
,
ÈÈ 

totalCount
ÍÍ 
,
ÍÍ 

pagination
ÎÎ 
.
ÎÎ 

PageNumber
ÎÎ !
,
ÎÎ! "

pagination
ÏÏ 
.
ÏÏ 
PageSize
ÏÏ 
)
ÌÌ 	
;
ÌÌ	 

}
ÓÓ 
public
ÒÒ 

async
ÒÒ 
Task
ÒÒ 
<
ÒÒ 
PropositionDto
ÒÒ $
?
ÒÒ$ %
>
ÒÒ% &+
DeletePropositionAsAdminAsync
ÒÒ' D
(
ÒÒD E
int
ÒÒE H
id
ÒÒI K
,
ÒÒK L
string
ÒÒM S
	userEmail
ÒÒT ]
)
ÒÒ] ^
{
ÚÚ 
logger
ÛÛ 
.
ÛÛ 
LogInformation
ÛÛ 
(
ÛÛ 
$str
ÛÛ y
,
ÛÛy z
id
ÛÛ{ }
,
ÛÛ} ~
	userEmailÛÛ à
)ÛÛà â
;ÛÛâ ä
var
ıı 
proposition
ıı 
=
ıı 
await
ıı 

unitOfWork
ıı  *
.
ıı* +
Propositions
ıı+ 7
.
ıı7 8
GetByIdAsync
ıı8 D
(
ııD E
id
ııE G
)
ııG H
;
ııH I
if
ˆˆ 

(
ˆˆ 
proposition
ˆˆ 
==
ˆˆ 
null
ˆˆ 
||
ˆˆ  "
proposition
ˆˆ# .
.
ˆˆ. /
	IsDeleted
ˆˆ/ 8
)
ˆˆ8 9
{
˜˜ 	
logger
¯¯ 
.
¯¯ 

LogWarning
¯¯ 
(
¯¯ 
$str
¯¯ m
,
¯¯m n
id
¯¯o q
)
¯¯q r
;
¯¯r s
return
˘˘ 
null
˘˘ 
;
˘˘ 
}
˙˙ 	
var
˝˝ 
user
˝˝ 
=
˝˝ 
await
˝˝ 

unitOfWork
˝˝ #
.
˝˝# $
Users
˝˝$ )
.
˝˝) *
GetByEmailAsync
˝˝* 9
(
˝˝9 :
	userEmail
˝˝: C
)
˝˝C D
;
˝˝D E
if
˛˛ 

(
˛˛ 
user
˛˛ 
==
˛˛ 
null
˛˛ 
)
˛˛ 
{
ˇˇ 	
logger
ÄÄ 
.
ÄÄ 
LogError
ÄÄ 
(
ÄÄ 
$str
ÄÄ k
,
ÄÄk l
	userEmail
ÄÄm v
)
ÄÄv w
;
ÄÄw x
throw
ÅÅ 
new
ÅÅ )
UnauthorizedAccessException
ÅÅ 1
(
ÅÅ1 2
$"
ÅÅ2 4
$str
ÅÅ4 D
{
ÅÅD E
	userEmail
ÅÅE N
}
ÅÅN O
"
ÅÅO P
)
ÅÅP Q
;
ÅÅQ R
}
ÇÇ 	
bool
ÖÖ 
isEsnMember
ÖÖ 
=
ÖÖ 
user
ÖÖ 
.
ÖÖ  
StudentType
ÖÖ  +
?
ÖÖ+ ,
.
ÖÖ, -
ToLower
ÖÖ- 4
(
ÖÖ4 5
)
ÖÖ5 6
==
ÖÖ7 9
$str
ÖÖ: F
;
ÖÖF G
bool
ÜÜ 
isAdmin
ÜÜ 
=
ÜÜ 
user
ÜÜ 
.
ÜÜ 
Role
ÜÜ  
?
ÜÜ  !
.
ÜÜ! "
Name
ÜÜ" &
==
ÜÜ' )
UserRole
ÜÜ* 2
.
ÜÜ2 3
Admin
ÜÜ3 8
;
ÜÜ8 9
if
àà 

(
àà 
!
àà 
isEsnMember
àà 
&&
àà 
!
àà 
isAdmin
àà $
)
àà$ %
{
ââ 	
logger
ää 
.
ää 

LogWarning
ää 
(
ää 
$strää Æ
,ääÆ Ø
	userEmail
ãã 
,
ãã 
user
ãã 
.
ãã  
Id
ãã  "
,
ãã" #
id
ãã$ &
)
ãã& '
;
ãã' (
throw
åå 
new
åå )
UnauthorizedAccessException
åå 1
(
åå1 2
$str
åå2 m
)
ååm n
;
åån o
}
çç 	
proposition
êê 
.
êê 
	IsDeleted
êê 
=
êê 
true
êê  $
;
êê$ %
proposition
ëë 
.
ëë 
	DeletedAt
ëë 
=
ëë 
DateTime
ëë  (
.
ëë( )
UtcNow
ëë) /
;
ëë/ 0

unitOfWork
ìì 
.
ìì 
Propositions
ìì 
.
ìì  
Update
ìì  &
(
ìì& '
proposition
ìì' 2
)
ìì2 3
;
ìì3 4
await
îî 

unitOfWork
îî 
.
îî 
SaveChangesAsync
îî )
(
îî) *
)
îî* +
;
îî+ ,
logger
ññ 
.
ññ 
LogInformation
ññ 
(
ññ 
$str
ññ |
,
ññ| }
idññ~ Ä
,ññÄ Å
	userEmailññÇ ã
)ññã å
;ññå ç
return
òò 
mapper
òò 
.
òò 
Map
òò 
<
òò 
PropositionDto
òò (
>
òò( )
(
òò) *
proposition
òò* 5
)
òò5 6
;
òò6 7
}
ôô 
}öö ê
FC:\Users\micha\Projects\ESN-WebApi\Business\Interfaces\IUserService.cs
	namespace 	
Business
 
. 

Interfaces 
; 
public

 
	interface

 
IUserService

 
{ 
Task 
< 	 
UserLoginResponseDto	 
> 

LoginAsync )
() *
UserLoginDto* 6
loginDto7 ?
)? @
;@ A
Task'' 
<'' 	 
UserLoginResponseDto''	 
>'' 
RefreshTokenAsync'' 0
(''0 1
string''1 7
token''8 =
)''= >
;''> ?
Task22 
<22 	
UserDto22	 
?22 
>22 
GetCurrentUserAsync22 &
(22& '
string22' -
	userEmail22. 7
)227 8
;228 9
Task<< 
<<< 	
IEnumerable<<	 
<<< 
UserDto<< 
><< 
><< 
GetAllUsersAsync<< /
(<</ 0
)<<0 1
;<<1 2
TaskHH 
<HH 	
PagedResultHH	 
<HH 
UserDtoHH 
>HH 
>HH 
GetAllUsersAsyncHH /
(HH/ 0
PaginationParamsHH0 @

paginationHHA K
)HHK L
;HHL M
TaskSS 
<SS 	
UserDtoSS	 
?SS 
>SS 
GetUserByIdAsyncSS #
(SS# $
intSS$ '
idSS( *
)SS* +
;SS+ ,
Task]] 
<]] 	
IEnumerable]]	 
<]] 
UserDto]] 
>]] 
>]] 
GetEsnMembersAsync]] 1
(]]1 2
)]]2 3
;]]3 4
Taskll 
<ll 	
UserDtoll	 
>ll 
CreateUserAsyncll !
(ll! "
UserCreateDtoll" /
	createDtoll0 9
)ll9 :
;ll: ;
Task{{ 
<{{ 	
UserDto{{	 
?{{ 
>{{ 
UpdatePasswordAsync{{ &
({{& '
int{{' *
id{{+ -
,{{- .!
UserPasswordChangeDto{{/ D
passwordDto{{E P
){{P Q
;{{Q R
Task
åå 
<
åå 	
UserDto
åå	 
?
åå 
>
åå 
UpdateUserAsync
åå "
(
åå" #
int
åå# &
id
åå' )
,
åå) *
UserUpdateDto
åå+ 8
userDto
åå9 @
)
åå@ A
;
ååA B
Task
óó 
<
óó 	
IEnumerable
óó	 
<
óó 
UserDto
óó 
>
óó 
>
óó #
GetUsersByStatusAsync
óó 4
(
óó4 5

UserStatus
óó5 ?
status
óó@ F
)
óóF G
;
óóG H
Task
§§ 
ApproveUserAsync
§§	 
(
§§ 
int
§§ 
userId
§§ $
)
§§$ %
;
§§% &
Task
≤≤ 
RejectUserAsync
≤≤	 
(
≤≤ 
int
≤≤ 
userId
≤≤ #
,
≤≤# $
string
≤≤% +
?
≤≤+ ,
reason
≤≤- 3
=
≤≤4 5
null
≤≤6 :
)
≤≤: ;
;
≤≤; <
Task
¡¡ 
<
¡¡ 	
UserDto
¡¡	 
?
¡¡ 
>
¡¡ 
DeleteUserAsync
¡¡ "
(
¡¡" #
int
¡¡# &
id
¡¡' )
)
¡¡) *
;
¡¡* +
}¬¬ é
MC:\Users\micha\Projects\ESN-WebApi\Business\Interfaces\IPropositionService.cs
	namespace 	
Business
 
. 

Interfaces 
; 
public 
	interface 
IPropositionService $
{ 
Task 
< 	
IEnumerable	 
< 
PropositionDto #
># $
>$ %#
GetAllPropositionsAsync& =
(= >
)> ?
;? @
Task%% 
<%% 	
PagedResult%%	 
<%% 
PropositionDto%% #
>%%# $
>%%$ %#
GetAllPropositionsAsync%%& =
(%%= >
PaginationParams%%> N

pagination%%O Y
,%%Y Z
string%%[ a
?%%a b
	userEmail%%c l
=%%m n
null%%o s
)%%s t
;%%t u
Task11 
<11 	
PropositionDto11	 
?11 
>11 #
GetPropositionByIdAsync11 1
(111 2
int112 5
id116 8
,118 9
string11: @
?11@ A
	userEmail11B K
=11L M
null11N R
)11R S
;11S T
Task== 
<== 	
PropositionDto==	 
>== "
CreatePropositionAsync== /
(==/ 0
PropositionDto==0 >
propositionDto==? M
,==M N
string==O U
	userEmail==V _
)==_ `
;==` a
TaskKK 
<KK 	
PropositionDtoKK	 
?KK 
>KK "
UpdatePropositionAsyncKK 0
(KK0 1
intKK1 4
idKK5 7
,KK7 8
PropositionDtoKK9 G
propositionDtoKKH V
,KKV W
stringKKX ^
	userEmailKK_ h
)KKh i
;KKi j
TaskYY 
<YY 	
PropositionDtoYY	 
?YY 
>YY "
DeletePropositionAsyncYY 0
(YY0 1
intYY1 4
idYY5 7
,YY7 8
stringYY9 ?
	userEmailYY@ I
)YYI J
;YYJ K
Taskjj 
<jj 	
PropositionDtojj	 
?jj 
>jj 
VoteUpAsyncjj %
(jj% &
intjj& )
idjj* ,
,jj, -
stringjj. 4
	userEmailjj5 >
)jj> ?
;jj? @
Task{{ 
<{{ 	
PropositionDto{{	 
?{{ 
>{{ 
VoteDownAsync{{ '
({{' (
int{{( +
id{{, .
,{{. /
string{{0 6
	userEmail{{7 @
){{@ A
;{{A B
Task
åå 
<
åå 	
PagedResult
åå	 
<
åå 
PropositionDto
åå #
>
åå# $
>
åå$ %-
GetAllPropositionsForAdminAsync
åå& E
(
ååE F
PaginationParams
çç 

pagination
çç #
,
çç# $"
PropositionFilterDto
éé 
filter
éé #
,
éé# $
string
èè 
?
èè 
	userEmail
èè 
=
èè 
null
èè  
)
èè  !
;
èè! "
Task
ûû 
<
ûû 	
PropositionDto
ûû	 
?
ûû 
>
ûû +
DeletePropositionAsAdminAsync
ûû 7
(
ûû7 8
int
ûû8 ;
id
ûû< >
,
ûû> ?
string
ûû@ F
	userEmail
ûûG P
)
ûûP Q
;
ûûQ R
}üü ”
OC:\Users\micha\Projects\ESN-WebApi\Business\Interfaces\IEventTemplateService.cs
	namespace 	
Business
 
. 

Interfaces 
; 
public

 
	interface

 !
IEventTemplateService

 &
{ 
Task 
< 	
IEnumerable	 
< 
EventTemplateDto %
>% &
>& ' 
GetAllTemplatesAsync( <
(< =
)= >
;> ?
Task   
<   	
PagedResult  	 
<   
EventTemplateDto   %
>  % &
>  & ' 
GetAllTemplatesAsync  ( <
(  < =
PaginationParams  = M

pagination  N X
)  X Y
;  Y Z
Task** 
<** 	
EventTemplateDto**	 
?** 
>**  
GetTemplateByIdAsync** 0
(**0 1
int**1 4
id**5 7
)**7 8
;**8 9
Task55 
<55 	
EventTemplateDto55	 
>55 
CreateTemplateAsync55 .
(55. /"
CreateEventTemplateDto55/ E
createTemplateDto55F W
)55W X
;55X Y
Task@@ 
<@@ 	
EventTemplateDto@@	 
?@@ 
>@@ 
UpdateTemplateAsync@@ /
(@@/ 0
int@@0 3
id@@4 6
,@@6 7
EventTemplateDto@@8 H
templateDto@@I T
)@@T U
;@@U V
TaskKK 
<KK 	
boolKK	 
>KK 
DeleteTemplateAsyncKK "
(KK" #
intKK# &
idKK' )
)KK) *
;KK* +
Task\\ 
<\\ 	
EventDto\\	 
>\\ (
CreateEventFromTemplateAsync\\ /
(\\/ 0&
CreateEventFromTemplateDto\\0 J&
createEventFromTemplateDto\\K e
,\\e f
string\\g m
	userEmail\\n w
)\\w x
;\\x y
Taskii 
<ii 	
EventTemplateDtoii	 
>ii $
SaveEventAsTemplateAsyncii 3
(ii3 4
intii4 7
eventIdii8 ?
)ii? @
;ii@ A
}jj à
GC:\Users\micha\Projects\ESN-WebApi\Business\Interfaces\IEventService.cs
	namespace 	
Business
 
. 

Interfaces 
; 
public		 
	interface		 
IEventService		 
{

 
Task 
< 	
IEnumerable	 
< 
EventDto 
> 
> 
GetAllEventsAsync  1
(1 2
)2 3
;3 4
Task 
< 	
IEnumerable	 
< 
EventDto 
> 
> %
GetAllEventsForAdminAsync  9
(9 :
): ;
;; <
Task++ 
<++ 	
PagedResult++	 
<++ 
EventDto++ 
>++ 
>++ 
GetAllEventsAsync++  1
(++1 2
PaginationParams++2 B

pagination++C M
,++M N
string++O U
?++U V
	userEmail++W `
=++a b
null++c g
)++g h
;++h i
Task77 
<77 	
EventDto77	 
?77 
>77 
GetEventByIdAsync77 %
(77% &
int77& )
id77* ,
,77, -
string77. 4
?774 5
	userEmail776 ?
=77@ A
null77B F
)77F G
;77G H
TaskCC 
<CC 	
EventDtoCC	 
>CC 
CreateEventAsyncCC #
(CC# $
CreateEventDtoCC$ 2
createEventDtoCC3 A
,CCA B
stringCCC I
	userEmailCCJ S
)CCS T
;CCT U
TaskPP 
<PP 	
EventDtoPP	 
?PP 
>PP 
UpdateEventAsyncPP $
(PP$ %
intPP% (
idPP) +
,PP+ ,
EventDtoPP- 5
eventDtoPP6 >
,PP> ?
stringPP@ F
	userEmailPPG P
)PPP Q
;PPQ R
Task]] 
<]] 	
bool]]	 
>]] 
DeleteEventAsync]] 
(]]  
int]]  #
id]]$ &
,]]& '
string]]( .
	userEmail]]/ 8
)]]8 9
;]]9 :
Taskoo 
<oo 	
stringoo	 
>oo !
RegisterForEventAsyncoo &
(oo& '
intoo' *
eventIdoo+ 2
,oo2 3
stringoo4 :
	userEmailoo; D
,ooD E
stringooF L
?ooL M
surveyJsDataooN Z
)ooZ [
;oo[ \
Task|| 
<|| 	
string||	 
>|| $
UnregisterFromEventAsync|| )
(||) *
int||* -
eventId||. 5
,||5 6
string||7 =
	userEmail||> G
)||G H
;||H I
Task
áá 
<
áá 	'
EventWithRegistrationsDto
áá	 "
?
áá" #
>
áá# $(
GetEventRegistrationsAsync
áá% ?
(
áá? @
int
áá@ C
eventId
ááD K
)
ááK L
;
ááL M
}àà é
JC:\Users\micha\Projects\ESN-WebApi\Business\Interfaces\ICalendarService.cs
	namespace 	
Business
 
. 

Interfaces 
; 
public		 
	interface		 
ICalendarService		 !
{

 
Task 
< 	
IEnumerable	 
< 
CalendarDto  
>  !
>! " 
GetAllCalendarsAsync# 7
(7 8
)8 9
;9 :
Task 
< 	
PagedResult	 
< 
CalendarDto  
>  !
>! " 
GetAllCalendarsAsync# 7
(7 8
PaginationParams8 H

paginationI S
)S T
;T U
Task)) 
<)) 	
CalendarDto))	 
?)) 
>))  
GetCalendarByIdAsync)) +
())+ ,
int)), /
id))0 2
)))2 3
;))3 4
Task33 
<33 	
IEnumerable33	 
<33 
CalendarDto33  
>33  !
>33! "&
GetCalendarsByEventIdAsync33# =
(33= >
int33> A
eventId33B I
)33I J
;33J K
Task== 
<== 	
IEnumerable==	 
<== 
CalendarDto==  
>==  !
>==! "&
GetAvailableCalendarsAsync==# =
(=== >
)==> ?
;==? @
TaskMM 
<MM 	
CalendarDtoMM	 
>MM 
CreateCalendarAsyncMM )
(MM) *
CalendarCreateDtoMM* ;
	createDtoMM< E
)MME F
;MMF G
Task[[ 
<[[ 	
CalendarDto[[	 
?[[ 
>[[ 
UpdateCalendarAsync[[ *
([[* +
int[[+ .
id[[/ 1
,[[1 2
CalendarUpdateDto[[3 D
	updateDto[[E N
,[[N O
string[[P V
	userEmail[[W `
)[[` a
;[[a b
Taskhh 
<hh 	
CalendarDtohh	 
?hh 
>hh 
DeleteCalendarAsynchh *
(hh* +
inthh+ .
idhh/ 1
,hh1 2
stringhh3 9
	userEmailhh: C
)hhC D
;hhD E
}ii »
RC:\Users\micha\Projects\ESN-WebApi\Business\Exceptions\ForbiddenAccessException.cs
	namespace 	
Business
 
. 

Exceptions 
; 
public 
class $
ForbiddenAccessException %
:& '
	Exception( 1
{ 
public		 
$
ForbiddenAccessException		 #
(		# $
)		$ %
:		& '
base		( ,
(		, -
)		- .
{

 
} 
public 
$
ForbiddenAccessException #
(# $
string$ *
message+ 2
)2 3
:4 5
base6 :
(: ;
message; B
)B C
{ 
} 
public 
$
ForbiddenAccessException #
(# $
string$ *
message+ 2
,2 3
	Exception4 =
innerException> L
)L M
:N O
baseP T
(T U
messageU \
,\ ]
innerException^ l
)l m
{ 
} 
} ﬁ¯
AC:\Users\micha\Projects\ESN-WebApi\Business\Event\EventService.cs
	namespace

 	
Business


 
.

 
Event

 
;

 
public 
class 
EventService 
( 
IUnitOfWork %

unitOfWork& 0
,0 1
IMapper2 9
mapper: @
,@ A
ILoggerB I
<I J
EventServiceJ V
>V W
loggerX ^
)^ _
: 
IEventService 
{ 
[ 
Obsolete 
( 
$str w
)w x
]x y
public 

async 
Task 
< 
IEnumerable !
<! "
EventDto" *
>* +
>+ ,
GetAllEventsAsync- >
(> ?
)? @
{ 
logger 
. 
LogInformation 
( 
$str b
)b c
;c d
var 
events 
= 
await 

unitOfWork %
.% &
Events& ,
., -(
GetAllEventsWithDetailsAsync- I
(I J
)J K
;K L
var 
	eventDtos 
= 
events 
. 
Select %
(% &
e& '
=>( *
{ 	
var 
dto 
= 
mapper 
. 
Map  
<  !
EventDto! )
>) *
(* +
e+ ,
), -
;- .
dto 
. 
RegisteredCount 
=  !
e" #
.# $
EventRegistrations$ 6
.6 7
Count7 <
(< =
r= >
=>? A
rB C
.C D
StatusD J
==K M
RegistrationStatusN `
.` a

Registereda k
)k l
;l m
return 
dto 
; 
} 	
)	 

;
 
logger!! 
.!! 
LogInformation!! 
(!! 
$str!! b
,!!b c
events!!d j
.!!j k
Count!!k p
(!!p q
)!!q r
)!!r s
;!!s t
return## 
	eventDtos## 
;## 
}$$ 
public'' 

async'' 
Task'' 
<'' 
IEnumerable'' !
<''! "
EventDto''" *
>''* +
>''+ ,%
GetAllEventsForAdminAsync''- F
(''F G
)''G H
{(( 
logger)) 
.)) 
LogInformation)) 
()) 
$str)) \
)))\ ]
;))] ^
var++ 
events++ 
=++ 
await++ 

unitOfWork++ %
.++% &
Events++& ,
.++, -%
GetAllEventsForAdminAsync++- F
(++F G
)++G H
;++H I
var-- 
	eventDtos-- 
=-- 
events-- 
.-- 
Select-- %
(--% &
e--& '
=>--( *
{.. 	
var// 
dto// 
=// 
mapper// 
.// 
Map//  
<//  !
EventDto//! )
>//) *
(//* +
e//+ ,
)//, -
;//- .
dto00 
.00 
RegisteredCount00 
=00  !
e00" #
.00# $
EventRegistrations00$ 6
.006 7
Count007 <
(00< =
r00= >
=>00? A
r00B C
.00C D
Status00D J
==00K M
RegistrationStatus00N `
.00` a

Registered00a k
)00k l
;00l m
return11 
dto11 
;11 
}22 	
)22	 

;22
 
logger44 
.44 
LogInformation44 
(44 
$str	44 Ç
,
44Ç É
events
44Ñ ä
.
44ä ã
Count
44ã ê
(
44ê ë
)
44ë í
)
44í ì
;
44ì î
return66 
	eventDtos66 
;66 
}77 
public:: 

async:: 
Task:: 
<:: 
PagedResult:: !
<::! "
EventDto::" *
>::* +
>::+ ,
GetAllEventsAsync::- >
(::> ?
PaginationParams::? O

pagination::P Z
,::Z [
string::\ b
?::b c
	userEmail::d m
=::n o
null::p t
)::t u
{;; 
logger<< 
.<< 
LogInformation<< 
(<< 
$str	<< ç
,
<<ç é

pagination== 
.== 

PageNumber== !
,==! "

pagination==# -
.==- .
PageSize==. 6
,==6 7
	userEmail==8 A
??==B D
$str==E P
)==P Q
;==Q R
var@@ 
(@@ 
events@@ 
,@@ 

totalCount@@ 
)@@  
=@@! "
await@@# (

unitOfWork@@) 3
.@@3 4
Events@@4 :
.@@: ;
GetEventsPagedAsync@@; N
(@@N O

paginationAA 
.AA 
SkipAA 
,AA 

paginationBB 
.BB 
PageSizeBB 
)BB  
;BB  !
varEE 
	eventDtosEE 
=EE 
eventsEE 
.EE 
SelectEE %
(EE% &
eEE& '
=>EE( *
{FF 	
varGG 
dtoGG 
=GG 
mapperGG 
.GG 
MapGG  
<GG  !
EventDtoGG! )
>GG) *
(GG* +
eGG+ ,
)GG, -
;GG- .
dtoHH 
.HH 
RegisteredCountHH 
=HH  !
eHH" #
.HH# $
EventRegistrationsHH$ 6
.HH6 7
CountHH7 <
(HH< =
rHH= >
=>HH? A
rHHB C
.HHC D
StatusHHD J
==HHK M
RegistrationStatusHHN `
.HH` a

RegisteredHHa k
)HHk l
;HHl m
returnII 
dtoII 
;II 
}JJ 	
)JJ	 

.JJ
 
ToListJJ 
(JJ 
)JJ 
;JJ 
ifMM 

(MM 
!MM 
stringMM 
.MM 
IsNullOrEmptyMM !
(MM! "
	userEmailMM" +
)MM+ ,
)MM, -
{NN 	
varOO 
userOO 
=OO 
awaitOO 

unitOfWorkOO '
.OO' (
UsersOO( -
.OO- .
GetByEmailAsyncOO. =
(OO= >
	userEmailOO> G
)OOG H
;OOH I
ifPP 
(PP 
userPP 
!=PP 
nullPP 
)PP 
{QQ 
varRR 
eventIdsRR 
=RR 
	eventDtosRR (
.RR( )
SelectRR) /
(RR/ 0
eRR0 1
=>RR2 4
eRR5 6
.RR6 7
IdRR7 9
)RR9 :
.RR: ;
ToArrayRR; B
(RRB C
)RRC D
;RRD E
varUU 
userRegistrationsUU %
=UU& '
awaitUU( -

unitOfWorkUU. 8
.UU8 9
EventRegistrationsUU9 K
.VV #
GetByUserAndEventsAsyncVV ,
(VV, -
userVV- 1
.VV1 2
IdVV2 4
,VV4 5
eventIdsVV6 >
)VV> ?
;VV? @
varYY 
registrationDictYY $
=YY% &
userRegistrationsYY' 8
.ZZ 
WhereZZ 
(ZZ 
rZZ 
=>ZZ 
rZZ  !
.ZZ! "
StatusZZ" (
==ZZ) +
RegistrationStatusZZ, >
.ZZ> ?

RegisteredZZ? I
)ZZI J
.[[ 
ToDictionary[[ !
([[! "
r[[" #
=>[[$ &
r[[' (
.[[( )
EventId[[) 0
)[[0 1
;[[1 2
foreach^^ 
(^^ 
var^^ 
eventDto^^ %
in^^& (
	eventDtos^^) 2
)^^2 3
{__ 
eventDto`` 
.`` #
IsCurrentUserRegistered`` 4
=``5 6
registrationDict``7 G
.``G H
ContainsKey``H S
(``S T
eventDto``T \
.``\ ]
Id``] _
)``_ `
;``` a
}aa 
loggercc 
.cc 
LogInformationcc %
(cc% &
$strcc& |
,cc| }
	userEmaildd 
,dd 
registrationDictdd /
.dd/ 0
Countdd0 5
)dd5 6
;dd6 7
}ee 
}ff 	
loggerhh 
.hh 
LogInformationhh 
(hh 
$strhh ~
,hh~ 
	eventDtosii 
.ii 
Countii 
,ii 

totalCountii '
)ii' (
;ii( )
returnkk 
newkk 
PagedResultkk 
<kk 
EventDtokk '
>kk' (
(kk( )
	eventDtoskk) 2
,kk2 3

totalCountkk4 >
,kk> ?

paginationkk@ J
.kkJ K

PageNumberkkK U
,kkU V

paginationkkW a
.kka b
PageSizekkb j
)kkj k
;kkk l
}ll 
publicoo 

asyncoo 
Taskoo 
<oo 
EventDtooo 
?oo 
>oo  
GetEventByIdAsyncoo! 2
(oo2 3
intoo3 6
idoo7 9
,oo9 :
stringoo; A
?ooA B
	userEmailooC L
=ooM N
nullooO S
)ooS T
{pp 
loggerqq 
.qq 
LogInformationqq 
(qq 
$strqq m
,qqm n
idrr 
,rr 
	userEmailrr 
??rr 
$strrr (
)rr( )
;rr) *
vartt 
evttt 
=tt 
awaittt 

unitOfWorktt "
.tt" #
Eventstt# )
.tt) *$
GetEventWithDetailsAsynctt* B
(ttB C
idttC E
)ttE F
;ttF G
ifvv 

(vv 
evtvv 
==vv 
nullvv 
)vv 
{ww 	
loggerxx 
.xx 

LogWarningxx 
(xx 
$strxx U
,xxU V
idxxW Y
)xxY Z
;xxZ [
returnyy 
nullyy 
;yy 
}zz 	
var|| 
eventDto|| 
=|| 
mapper|| 
.|| 
Map|| !
<||! "
EventDto||" *
>||* +
(||+ ,
evt||, /
)||/ 0
;||0 1
eventDto}} 
.}} 
RegisteredCount}}  
=}}! "
evt}}# &
.}}& '
EventRegistrations}}' 9
.}}9 :
Count}}: ?
(}}? @
r}}@ A
=>}}B D
r}}E F
.}}F G
Status}}G M
==}}N P
RegistrationStatus}}Q c
.}}c d

Registered}}d n
)}}n o
;}}o p
if
ÄÄ 

(
ÄÄ 
!
ÄÄ 
string
ÄÄ 
.
ÄÄ 
IsNullOrEmpty
ÄÄ !
(
ÄÄ! "
	userEmail
ÄÄ" +
)
ÄÄ+ ,
)
ÄÄ, -
{
ÅÅ 	
var
ÇÇ 
user
ÇÇ 
=
ÇÇ 
await
ÇÇ 

unitOfWork
ÇÇ '
.
ÇÇ' (
Users
ÇÇ( -
.
ÇÇ- .
GetByEmailAsync
ÇÇ. =
(
ÇÇ= >
	userEmail
ÇÇ> G
)
ÇÇG H
;
ÇÇH I
if
ÉÉ 
(
ÉÉ 
user
ÉÉ 
!=
ÉÉ 
null
ÉÉ 
)
ÉÉ 
{
ÑÑ 
var
ÖÖ 
registration
ÖÖ  
=
ÖÖ! "
await
ÖÖ# (

unitOfWork
ÖÖ) 3
.
ÖÖ3 4
Events
ÖÖ4 :
.
ÖÖ: ;"
GetRegistrationAsync
ÖÖ; O
(
ÖÖO P
id
ÖÖP R
,
ÖÖR S
user
ÖÖT X
.
ÖÖX Y
Id
ÖÖY [
)
ÖÖ[ \
;
ÖÖ\ ]
eventDto
ÜÜ 
.
ÜÜ %
IsCurrentUserRegistered
ÜÜ 0
=
ÜÜ1 2
registration
ÜÜ3 ?
?
ÜÜ? @
.
ÜÜ@ A
Status
ÜÜA G
==
ÜÜH J 
RegistrationStatus
ÜÜK ]
.
ÜÜ] ^

Registered
ÜÜ^ h
;
ÜÜh i
logger
àà 
.
àà 
LogInformation
àà %
(
àà% &
$stràà& ä
,ààä ã
	userEmail
ââ 
,
ââ 
id
ââ !
,
ââ! "
eventDto
ââ# +
.
ââ+ ,%
IsCurrentUserRegistered
ââ, C
)
ââC D
;
ââD E
}
ää 
}
ãã 	
logger
çç 
.
çç 
LogInformation
çç 
(
çç 
$str
çç Y
,
ççY Z
id
çç[ ]
)
çç] ^
;
çç^ _
return
èè 
eventDto
èè 
;
èè 
}
êê 
public
ìì 

async
ìì 
Task
ìì 
<
ìì 
EventDto
ìì 
>
ìì 
CreateEventAsync
ìì  0
(
ìì0 1
CreateEventDto
ìì1 ?
createEventDto
ìì@ N
,
ììN O
string
ììP V
	userEmail
ììW `
)
ìì` a
{
îî 
logger
ïï 
.
ïï 
LogInformation
ïï 
(
ïï 
$str
ïï b
,
ïïb c
createEventDto
ññ 
.
ññ 
Title
ññ  
,
ññ  !
	userEmail
ññ" +
)
ññ+ ,
;
ññ, -
var
òò 
user
òò 
=
òò 
await
òò 

unitOfWork
òò #
.
òò# $
Users
òò$ )
.
òò) *
GetByEmailAsync
òò* 9
(
òò9 :
	userEmail
òò: C
)
òòC D
;
òòD E
if
ôô 

(
ôô 
user
ôô 
==
ôô 
null
ôô 
)
ôô 
{
öö 	
logger
õõ 
.
õõ 
LogError
õõ 
(
õõ 
$str
õõ _
,
õõ_ `
	userEmail
õõa j
)
õõj k
;
õõk l
throw
úú 
new
úú )
UnauthorizedAccessException
úú 1
(
úú1 2
$"
úú2 4
$str
úú4 D
{
úúD E
	userEmail
úúE N
}
úúN O
"
úúO P
)
úúP Q
;
úúQ R
}
ùù 	
Bo
†† 

.
††
 
Models
†† 
.
†† 

CalendarBo
†† 
?
†† 
calendar
†† &
=
††' (
null
††) -
;
††- .
if
°° 

(
°° 
createEventDto
°° 
.
°° 

CalendarId
°° %
.
°°% &
HasValue
°°& .
)
°°. /
{
¢¢ 	
calendar
££ 
=
££ 
await
££ 

unitOfWork
££ '
.
££' (
	Calendars
££( 1
.
££1 2
GetByIdAsync
££2 >
(
££> ?
createEventDto
££? M
.
££M N

CalendarId
££N X
.
££X Y
Value
££Y ^
)
££^ _
;
££_ `
if
§§ 
(
§§ 
calendar
§§ 
==
§§ 
null
§§  
)
§§  !
{
•• 
logger
¶¶ 
.
¶¶ 
LogError
¶¶ 
(
¶¶  
$str
¶¶  a
,
¶¶a b
createEventDto
ßß "
.
ßß" #

CalendarId
ßß# -
.
ßß- .
Value
ßß. 3
)
ßß3 4
;
ßß4 5
throw
®® 
new
®® 
ArgumentException
®® +
(
®®+ ,
$"
®®, .
$str
®®. B
{
®®B C
createEventDto
®®C Q
.
®®Q R

CalendarId
®®R \
.
®®\ ]
Value
®®] b
}
®®b c
"
®®c d
)
®®d e
;
®®e f
}
©© 
if
´´ 
(
´´ 
calendar
´´ 
.
´´ 
EventId
´´  
.
´´  !
HasValue
´´! )
)
´´) *
{
¨¨ 
logger
≠≠ 
.
≠≠ 
LogError
≠≠ 
(
≠≠  
$str
≠≠  y
,
≠≠y z
calendar
ÆÆ 
.
ÆÆ 
Id
ÆÆ 
,
ÆÆ  
calendar
ÆÆ! )
.
ÆÆ) *
EventId
ÆÆ* 1
.
ÆÆ1 2
Value
ÆÆ2 7
)
ÆÆ7 8
;
ÆÆ8 9
throw
ØØ 
new
ØØ '
InvalidOperationException
ØØ 3
(
ØØ3 4
$"
∞∞ 
$str
∞∞  
{
∞∞  !
calendar
∞∞! )
.
∞∞) *
Title
∞∞* /
}
∞∞/ 0
$str
∞∞0 T
"
∞∞T U
)
∞∞U V
;
∞∞V W
}
±± 
}
≤≤ 	
await
¥¥ 

unitOfWork
¥¥ 
.
¥¥ #
BeginTransactionAsync
¥¥ .
(
¥¥. /
)
¥¥/ 0
;
¥¥0 1
try
µµ 
{
∂∂ 	
var
∑∑ 
evt
∑∑ 
=
∑∑ 
mapper
∑∑ 
.
∑∑ 
Map
∑∑  
<
∑∑  !
Bo
∑∑! #
.
∑∑# $
Models
∑∑$ *
.
∑∑* +
EventBo
∑∑+ 2
>
∑∑2 3
(
∑∑3 4
createEventDto
∑∑4 B
)
∑∑B C
;
∑∑C D
evt
∏∏ 
.
∏∏ 
UserId
∏∏ 
=
∏∏ 
user
∏∏ 
.
∏∏ 
Id
∏∏  
;
∏∏  !
evt
ππ 
.
ππ 
	CreatedAt
ππ 
=
ππ 
DateTime
ππ $
.
ππ$ %
UtcNow
ππ% +
;
ππ+ ,
await
ªª 

unitOfWork
ªª 
.
ªª 
Events
ªª #
.
ªª# $
AddAsync
ªª$ ,
(
ªª, -
evt
ªª- 0
)
ªª0 1
;
ªª1 2
await
ºº 

unitOfWork
ºº 
.
ºº 
SaveChangesAsync
ºº -
(
ºº- .
)
ºº. /
;
ºº/ 0
logger
ææ 
.
ææ 
LogInformation
ææ !
(
ææ! "
$str
ææ" ^
,
ææ^ _
evt
ææ` c
.
ææc d
Id
ææd f
)
ææf g
;
ææg h
if
¡¡ 
(
¡¡ 
calendar
¡¡ 
!=
¡¡ 
null
¡¡  
)
¡¡  !
{
¬¬ 
calendar
√√ 
.
√√ 
EventId
√√  
=
√√! "
evt
√√# &
.
√√& '
Id
√√' )
;
√√) *

unitOfWork
ƒƒ 
.
ƒƒ 
	Calendars
ƒƒ $
.
ƒƒ$ %
Update
ƒƒ% +
(
ƒƒ+ ,
calendar
ƒƒ, 4
)
ƒƒ4 5
;
ƒƒ5 6
await
≈≈ 

unitOfWork
≈≈  
.
≈≈  !
SaveChangesAsync
≈≈! 1
(
≈≈1 2
)
≈≈2 3
;
≈≈3 4
logger
«« 
.
«« 
LogInformation
«« %
(
««% &
$str
»» e
,
»»e f
calendar
…… 
.
…… 
Id
…… 
,
……  
evt
……! $
.
……$ %
Id
……% '
)
……' (
;
……( )
}
   
await
ÃÃ 

unitOfWork
ÃÃ 
.
ÃÃ $
CommitTransactionAsync
ÃÃ 3
(
ÃÃ3 4
)
ÃÃ4 5
;
ÃÃ5 6
var
œœ 
createdEvent
œœ 
=
œœ 
await
œœ $

unitOfWork
œœ% /
.
œœ/ 0
Events
œœ0 6
.
œœ6 7&
GetEventWithDetailsAsync
œœ7 O
(
œœO P
evt
œœP S
.
œœS T
Id
œœT V
)
œœV W
;
œœW X
var
—— 
responseDto
—— 
=
—— 
mapper
—— $
.
——$ %
Map
——% (
<
——( )
EventDto
——) 1
>
——1 2
(
——2 3
createdEvent
——3 ?
!
——? @
)
——@ A
;
——A B
responseDto
““ 
.
““ 
RegisteredCount
““ '
=
““( )
$num
““* +
;
““+ ,
logger
‘‘ 
.
‘‘ 
LogInformation
‘‘ !
(
‘‘! "
$str
‘‘" b
,
‘‘b c
evt
’’ 
.
’’ 
Title
’’ 
,
’’ 
user
’’ 
.
’’  
Email
’’  %
)
’’% &
;
’’& '
return
◊◊ 
responseDto
◊◊ 
;
◊◊ 
}
ÿÿ 	
catch
ŸŸ 
{
⁄⁄ 	
await
€€ 

unitOfWork
€€ 
.
€€ &
RollbackTransactionAsync
€€ 5
(
€€5 6
)
€€6 7
;
€€7 8
throw
‹‹ 
;
‹‹ 
}
›› 	
}
ﬁﬁ 
public
·· 

async
·· 
Task
·· 
<
·· 
EventDto
·· 
?
·· 
>
··  
UpdateEventAsync
··! 1
(
··1 2
int
··2 5
id
··6 8
,
··8 9
EventDto
··: B
eventDto
··C K
,
··K L
string
··M S
	userEmail
··T ]
)
··] ^
{
‚‚ 
logger
„„ 
.
„„ 
LogInformation
„„ 
(
„„ 
$str
„„ s
,
„„s t
id
‰‰ 
,
‰‰ 
eventDto
‰‰ 
.
‰‰ 
Title
‰‰ 
,
‰‰ 
	userEmail
‰‰  )
)
‰‰) *
;
‰‰* +
var
ÊÊ 
existing
ÊÊ 
=
ÊÊ 
await
ÊÊ 

unitOfWork
ÊÊ '
.
ÊÊ' (
Events
ÊÊ( .
.
ÊÊ. /&
GetEventWithDetailsAsync
ÊÊ/ G
(
ÊÊG H
id
ÊÊH J
)
ÊÊJ K
;
ÊÊK L
if
ËË 

(
ËË 
existing
ËË 
==
ËË 
null
ËË 
)
ËË 
{
ÈÈ 	
logger
ÍÍ 
.
ÍÍ 

LogWarning
ÍÍ 
(
ÍÍ 
$str
ÍÍ T
,
ÍÍT U
id
ÍÍV X
)
ÍÍX Y
;
ÍÍY Z
return
ÎÎ 
null
ÎÎ 
;
ÎÎ 
}
ÏÏ 	
var
ÔÔ 
currentUser
ÔÔ 
=
ÔÔ 
await
ÔÔ 

unitOfWork
ÔÔ  *
.
ÔÔ* +
Users
ÔÔ+ 0
.
ÔÔ0 1
GetByEmailAsync
ÔÔ1 @
(
ÔÔ@ A
	userEmail
ÔÔA J
)
ÔÔJ K
;
ÔÔK L
if
 

(
 
currentUser
 
==
 
null
 
||
  "
(
# $
existing
$ ,
.
, -
UserId
- 3
!=
4 6
currentUser
7 B
.
B C
Id
C E
&&
F H
currentUser
I T
.
T U
StudentType
U `
!=
a c
Bo
d f
.
f g
	Constants
g p
.
p q
StudentType
q |
.
| }
	EsnMember} Ü
)Ü á
)á à
{
ÒÒ 	
logger
ÚÚ 
.
ÚÚ 

LogWarning
ÚÚ 
(
ÚÚ 
$str
ÚÚ w
,
ÚÚw x
id
ÛÛ 
,
ÛÛ 
	userEmail
ÛÛ 
)
ÛÛ 
;
ÛÛ 
throw
ÙÙ 
new
ÙÙ )
UnauthorizedAccessException
ÙÙ 1
(
ÙÙ1 2
$"
ÙÙ2 4
$str
ÙÙ4 9
{
ÙÙ9 :
	userEmail
ÙÙ: C
}
ÙÙC D
$str
ÙÙD k
"
ÙÙk l
)
ÙÙl m
;
ÙÙm n
}
ıı 	
existing
¯¯ 
.
¯¯ 
Title
¯¯ 
=
¯¯ 
eventDto
¯¯ !
.
¯¯! "
Title
¯¯" '
;
¯¯' (
existing
˘˘ 
.
˘˘ 
Description
˘˘ 
=
˘˘ 
eventDto
˘˘ '
.
˘˘' (
Description
˘˘( 3
;
˘˘3 4
existing
˙˙ 
.
˙˙ 
Location
˙˙ 
=
˙˙ 
eventDto
˙˙ $
.
˙˙$ %
Location
˙˙% -
;
˙˙- .
existing
˚˚ 
.
˚˚ 
	StartDate
˚˚ 
=
˚˚ 
eventDto
˚˚ %
.
˚˚% &
	StartDate
˚˚& /
;
˚˚/ 0
existing
¸¸ 
.
¸¸ 
EndDate
¸¸ 
=
¸¸ 
eventDto
¸¸ #
.
¸¸# $
EndDate
¸¸$ +
;
¸¸+ ,
existing
˝˝ 
.
˝˝ 
MaxParticipants
˝˝  
=
˝˝! "
eventDto
˝˝# +
.
˝˝+ ,
MaxParticipants
˝˝, ;
;
˝˝; <
existing
˛˛ 
.
˛˛ 
EventfrogLink
˛˛ 
=
˛˛  
eventDto
˛˛! )
.
˛˛) *
EventfrogLink
˛˛* 7
;
˛˛7 8
existing
ˇˇ 
.
ˇˇ 
SurveyJsData
ˇˇ 
=
ˇˇ 
eventDto
ˇˇ  (
.
ˇˇ( )
SurveyJsData
ˇˇ) 5
;
ˇˇ5 6

unitOfWork
ÅÅ 
.
ÅÅ 
Events
ÅÅ 
.
ÅÅ 
Update
ÅÅ  
(
ÅÅ  !
existing
ÅÅ! )
)
ÅÅ) *
;
ÅÅ* +
try
ÉÉ 
{
ÑÑ 	
var
ÜÜ 
currentCalendar
ÜÜ 
=
ÜÜ  !
await
ÜÜ" '

unitOfWork
ÜÜ( 2
.
ÜÜ2 3
	Calendars
ÜÜ3 <
.
ÜÜ< ='
GetCalendarByEventIdAsync
ÜÜ= V
(
ÜÜV W
id
ÜÜW Y
)
ÜÜY Z
;
ÜÜZ [
var
áá 
currentCalendarId
áá !
=
áá" #
currentCalendar
áá$ 3
?
áá3 4
.
áá4 5
Id
áá5 7
;
áá7 8
if
ää 
(
ää 
eventDto
ää 
.
ää 

CalendarId
ää #
!=
ää$ &
currentCalendarId
ää' 8
)
ää8 9
{
ãã 
if
çç 
(
çç 
currentCalendar
çç #
!=
çç$ &
null
çç' +
)
çç+ ,
{
éé 
currentCalendar
èè #
.
èè# $
EventId
èè$ +
=
èè, -
null
èè. 2
;
èè2 3

unitOfWork
êê 
.
êê 
	Calendars
êê (
.
êê( )
Update
êê) /
(
êê/ 0
currentCalendar
êê0 ?
)
êê? @
;
êê@ A
logger
ëë 
.
ëë 
LogInformation
ëë )
(
ëë) *
$str
ëë* 
,ëë Ä
currentCalendar
íí '
.
íí' (
Id
íí( *
,
íí* +
id
íí, .
)
íí. /
;
íí/ 0
}
ìì 
if
ññ 
(
ññ 
eventDto
ññ 
.
ññ 

CalendarId
ññ '
.
ññ' (
HasValue
ññ( 0
)
ññ0 1
{
óó 
var
òò 
newCalendar
òò #
=
òò$ %
await
òò& +

unitOfWork
òò, 6
.
òò6 7
	Calendars
òò7 @
.
òò@ A
GetByIdAsync
òòA M
(
òòM N
eventDto
òòN V
.
òòV W

CalendarId
òòW a
.
òòa b
Value
òòb g
)
òòg h
;
òòh i
if
ôô 
(
ôô 
newCalendar
ôô #
==
ôô$ &
null
ôô' +
)
ôô+ ,
{
öö 
logger
õõ 
.
õõ 
LogError
õõ '
(
õõ' (
$str
õõ( i
,
õõi j
eventDto
úú $
.
úú$ %

CalendarId
úú% /
.
úú/ 0
Value
úú0 5
)
úú5 6
;
úú6 7
throw
ùù 
new
ùù !
ArgumentException
ùù" 3
(
ùù3 4
$"
ùù4 6
$str
ùù6 J
{
ùùJ K
eventDto
ùùK S
.
ùùS T

CalendarId
ùùT ^
.
ùù^ _
Value
ùù_ d
}
ùùd e
"
ùùe f
)
ùùf g
;
ùùg h
}
ûû 
if
†† 
(
†† 
newCalendar
†† #
.
††# $
EventId
††$ +
.
††+ ,
HasValue
††, 4
&&
††5 7
newCalendar
††8 C
.
††C D
EventId
††D K
.
††K L
Value
††L Q
!=
††R T
id
††U W
)
††W X
{
°° 
logger
¢¢ 
.
¢¢ 
LogError
¢¢ '
(
¢¢' (
$str¢¢( Å
,¢¢Å Ç
newCalendar
££ '
.
££' (
Id
££( *
,
££* +
newCalendar
££, 7
.
££7 8
EventId
££8 ?
.
££? @
Value
££@ E
)
££E F
;
££F G
throw
§§ 
new
§§ !'
InvalidOperationException
§§" ;
(
§§; <
$"
•• 
$str
•• (
{
••( )
newCalendar
••) 4
.
••4 5
Title
••5 :
}
••: ;
$str
••; _
"
••_ `
)
••` a
;
••a b
}
¶¶ 
newCalendar
®® 
.
®®  
EventId
®®  '
=
®®( )
id
®®* ,
;
®®, -

unitOfWork
©© 
.
©© 
	Calendars
©© (
.
©©( )
Update
©©) /
(
©©/ 0
newCalendar
©©0 ;
)
©©; <
;
©©< =
logger
™™ 
.
™™ 
LogInformation
™™ )
(
™™) *
$str
™™* {
,
™™{ |
newCalendar
´´ #
.
´´# $
Id
´´$ &
,
´´& '
id
´´( *
)
´´* +
;
´´+ ,
}
¨¨ 
}
≠≠ 
await
ØØ 

unitOfWork
ØØ 
.
ØØ 
SaveChangesAsync
ØØ -
(
ØØ- .
)
ØØ. /
;
ØØ/ 0
logger
∞∞ 
.
∞∞ 
LogInformation
∞∞ !
(
∞∞! "
$str
∞∞" c
,
∞∞c d
id
∞∞e g
)
∞∞g h
;
∞∞h i
}
±± 	
catch
≤≤ 
(
≤≤ 
	Exception
≤≤ 
ex
≤≤ 
)
≤≤ 
{
≥≥ 	
if
¥¥ 
(
¥¥ 
!
¥¥ 
await
¥¥ 

unitOfWork
¥¥ !
.
¥¥! "
Events
¥¥" (
.
¥¥( )
AnyAsync
¥¥) 1
(
¥¥1 2
e
¥¥2 3
=>
¥¥4 6
e
¥¥7 8
.
¥¥8 9
Id
¥¥9 ;
==
¥¥< >
id
¥¥? A
)
¥¥A B
)
¥¥B C
{
µµ 
logger
∂∂ 
.
∂∂ 

LogWarning
∂∂ !
(
∂∂! "
$str
∂∂" z
,
∂∂z {
id
∂∂| ~
)
∂∂~ 
;∂∂ Ä
return
∑∑ 
null
∑∑ 
;
∑∑ 
}
∏∏ 
logger
ππ 
.
ππ 
LogError
ππ 
(
ππ 
ex
ππ 
,
ππ 
$str
ππ  \
,
ππ\ ]
id
ππ^ `
)
ππ` a
;
ππa b
throw
∫∫ 
;
∫∫ 
}
ªª 	
var
ΩΩ 
responseDto
ΩΩ 
=
ΩΩ 
mapper
ΩΩ  
.
ΩΩ  !
Map
ΩΩ! $
<
ΩΩ$ %
EventDto
ΩΩ% -
>
ΩΩ- .
(
ΩΩ. /
existing
ΩΩ/ 7
)
ΩΩ7 8
;
ΩΩ8 9
responseDto
ææ 
.
ææ 
RegisteredCount
ææ #
=
ææ$ %
existing
ææ& .
.
ææ. / 
EventRegistrations
ææ/ A
.
ææA B
Count
ææB G
(
ææG H
r
ææH I
=>
ææJ L
r
ææM N
.
ææN O
Status
ææO U
==
ææV X 
RegistrationStatus
ææY k
.
ææk l

Registered
ææl v
)
ææv w
;
ææw x
logger
¿¿ 
.
¿¿ 
LogInformation
¿¿ 
(
¿¿ 
$str
¿¿ X
,
¿¿X Y
id
¿¿Z \
)
¿¿\ ]
;
¿¿] ^
return
¬¬ 
responseDto
¬¬ 
;
¬¬ 
}
√√ 
public
∆∆ 

async
∆∆ 
Task
∆∆ 
<
∆∆ 
bool
∆∆ 
>
∆∆ 
DeleteEventAsync
∆∆ ,
(
∆∆, -
int
∆∆- 0
id
∆∆1 3
,
∆∆3 4
string
∆∆5 ;
	userEmail
∆∆< E
)
∆∆E F
{
«« 
logger
»» 
.
»» 
LogInformation
»» 
(
»» 
$str
»» `
,
»»` a
id
»»b d
,
»»d e
	userEmail
»»f o
)
»»o p
;
»»p q
var
   
evt
   
=
   
await
   

unitOfWork
   "
.
  " #
Events
  # )
.
  ) *&
GetEventWithDetailsAsync
  * B
(
  B C
id
  C E
)
  E F
;
  F G
if
ÃÃ 

(
ÃÃ 
evt
ÃÃ 
==
ÃÃ 
null
ÃÃ 
)
ÃÃ 
{
ÕÕ 	
logger
ŒŒ 
.
ŒŒ 

LogWarning
ŒŒ 
(
ŒŒ 
$str
ŒŒ T
,
ŒŒT U
id
ŒŒV X
)
ŒŒX Y
;
ŒŒY Z
return
œœ 
false
œœ 
;
œœ 
}
–– 	
var
”” 
currentUser
”” 
=
”” 
await
”” 

unitOfWork
””  *
.
””* +
Users
””+ 0
.
””0 1
GetByEmailAsync
””1 @
(
””@ A
	userEmail
””A J
)
””J K
;
””K L
if
‘‘ 

(
‘‘ 
currentUser
‘‘ 
==
‘‘ 
null
‘‘ 
||
‘‘  "
(
‘‘# $
evt
‘‘$ '
.
‘‘' (
UserId
‘‘( .
!=
‘‘/ 1
currentUser
‘‘2 =
.
‘‘= >
Id
‘‘> @
&&
‘‘A C
currentUser
‘‘D O
.
‘‘O P
StudentType
‘‘P [
!=
‘‘\ ^
Bo
‘‘_ a
.
‘‘a b
	Constants
‘‘b k
.
‘‘k l
StudentType
‘‘l w
.
‘‘w x
	EsnMember‘‘x Å
)‘‘Å Ç
)‘‘Ç É
{
’’ 	
logger
÷÷ 
.
÷÷ 

LogWarning
÷÷ 
(
÷÷ 
$str
÷÷ w
,
÷÷w x
id
◊◊ 
,
◊◊ 
	userEmail
◊◊ 
)
◊◊ 
;
◊◊ 
throw
ÿÿ 
new
ÿÿ )
UnauthorizedAccessException
ÿÿ 1
(
ÿÿ1 2
$"
ÿÿ2 4
$str
ÿÿ4 9
{
ÿÿ9 :
	userEmail
ÿÿ: C
}
ÿÿC D
$str
ÿÿD k
"
ÿÿk l
)
ÿÿl m
;
ÿÿm n
}
ŸŸ 	

unitOfWork
‹‹ 
.
‹‹ 
Events
‹‹ 
.
‹‹ 
Delete
‹‹  
(
‹‹  !
evt
‹‹! $
)
‹‹$ %
;
‹‹% &
await
›› 

unitOfWork
›› 
.
›› 
SaveChangesAsync
›› )
(
››) *
)
››* +
;
››+ ,
logger
ﬂﬂ 
.
ﬂﬂ 
LogInformation
ﬂﬂ 
(
ﬂﬂ 
$str
ﬂﬂ c
,
ﬂﬂc d
id
‡‡ 
,
‡‡ 
evt
‡‡ 
.
‡‡ 
User
‡‡ 
.
‡‡ 
Email
‡‡ 
)
‡‡ 
;
‡‡  
return
‚‚ 
true
‚‚ 
;
‚‚ 
}
„„ 
public
ÊÊ 

async
ÊÊ 
Task
ÊÊ 
<
ÊÊ 
string
ÊÊ 
>
ÊÊ #
RegisterForEventAsync
ÊÊ 3
(
ÊÊ3 4
int
ÊÊ4 7
eventId
ÊÊ8 ?
,
ÊÊ? @
string
ÊÊA G
	userEmail
ÊÊH Q
,
ÊÊQ R
string
ÊÊS Y
?
ÊÊY Z
surveyJsData
ÊÊ[ g
)
ÊÊg h
{
ÁÁ 
logger
ËË 
.
ËË 
LogInformation
ËË 
(
ËË 
$str
ËË e
,
ËËe f
eventId
ÈÈ 
,
ÈÈ 
	userEmail
ÈÈ 
)
ÈÈ 
;
ÈÈ  
await
ÎÎ 

unitOfWork
ÎÎ 
.
ÎÎ #
BeginTransactionAsync
ÎÎ .
(
ÎÎ. /
)
ÎÎ/ 0
;
ÎÎ0 1
try
ÏÏ 
{
ÌÌ 	
var
ÓÓ 
user
ÓÓ 
=
ÓÓ 
await
ÓÓ 

unitOfWork
ÓÓ '
.
ÓÓ' (
Users
ÓÓ( -
.
ÓÓ- .
GetByEmailAsync
ÓÓ. =
(
ÓÓ= >
	userEmail
ÓÓ> G
)
ÓÓG H
;
ÓÓH I
if
ÔÔ 
(
ÔÔ 
user
ÔÔ 
==
ÔÔ 
null
ÔÔ 
)
ÔÔ 
{
 
logger
ÒÒ 
.
ÒÒ 
LogError
ÒÒ 
(
ÒÒ  
$str
ÒÒ  h
,
ÒÒh i
	userEmail
ÒÒj s
)
ÒÒs t
;
ÒÒt u
throw
ÚÚ 
new
ÚÚ )
UnauthorizedAccessException
ÚÚ 5
(
ÚÚ5 6
$"
ÚÚ6 8
$str
ÚÚ8 H
{
ÚÚH I
	userEmail
ÚÚI R
}
ÚÚR S
"
ÚÚS T
)
ÚÚT U
;
ÚÚU V
}
ÛÛ 
var
ıı 
evt
ıı 
=
ıı 
await
ıı 

unitOfWork
ıı &
.
ıı& '
Events
ıı' -
.
ıı- .&
GetEventWithDetailsAsync
ıı. F
(
ııF G
eventId
ııG N
)
ııN O
;
ııO P
if
˜˜ 
(
˜˜ 
evt
˜˜ 
==
˜˜ 
null
˜˜ 
)
˜˜ 
{
¯¯ 
logger
˘˘ 
.
˘˘ 

LogWarning
˘˘ !
(
˘˘! "
$str
˘˘" ]
,
˘˘] ^
eventId
˘˘_ f
)
˘˘f g
;
˘˘g h
throw
˙˙ 
new
˙˙ "
KeyNotFoundException
˙˙ .
(
˙˙. /
$"
˙˙/ 1
$str
˙˙1 B
{
˙˙B C
eventId
˙˙C J
}
˙˙J K
"
˙˙K L
)
˙˙L M
;
˙˙M N
}
˚˚ 
var
˛˛ 
now
˛˛ 
=
˛˛ 
DateTime
˛˛ 
.
˛˛ 
UtcNow
˛˛ %
;
˛˛% &
if
ˇˇ 
(
ˇˇ 
now
ˇˇ 
<
ˇˇ 
evt
ˇˇ 
.
ˇˇ 
	StartDate
ˇˇ #
)
ˇˇ# $
{
ÄÄ 
logger
ÅÅ 
.
ÅÅ 
LogInformation
ÅÅ %
(
ÅÅ% &
$str
ÅÅ& w
,
ÅÅw x
eventIdÅÅy Ä
)ÅÅÄ Å
;ÅÅÅ Ç
throw
ÇÇ 
new
ÇÇ '
InvalidOperationException
ÇÇ 3
(
ÇÇ3 4
$str
ÇÇ4 ]
)
ÇÇ] ^
;
ÇÇ^ _
}
ÉÉ 
if
ÖÖ 
(
ÖÖ 
evt
ÖÖ 
.
ÖÖ 
EndDate
ÖÖ 
.
ÖÖ 
HasValue
ÖÖ $
&&
ÖÖ% '
now
ÖÖ( +
>
ÖÖ, -
evt
ÖÖ. 1
.
ÖÖ1 2
EndDate
ÖÖ2 9
.
ÖÖ9 :
Value
ÖÖ: ?
)
ÖÖ? @
{
ÜÜ 
logger
áá 
.
áá 
LogInformation
áá %
(
áá% &
$str
áá& q
,
ááq r
eventId
áás z
)
ááz {
;
áá{ |
throw
àà 
new
àà '
InvalidOperationException
àà 3
(
àà3 4
$str
àà4 S
)
ààS T
;
ààT U
}
ââ 
var
åå "
existingRegistration
åå $
=
åå% &
await
åå' ,

unitOfWork
åå- 7
.
åå7 8
Events
åå8 >
.
åå> ?"
GetRegistrationAsync
åå? S
(
ååS T
eventId
ååT [
,
åå[ \
user
åå] a
.
ååa b
Id
ååb d
)
ååd e
;
ååe f
if
éé 
(
éé "
existingRegistration
éé $
!=
éé% '
null
éé( ,
)
éé, -
{
èè 
if
êê 
(
êê "
existingRegistration
êê (
.
êê( )
Status
êê) /
==
êê0 2 
RegistrationStatus
êê3 E
.
êêE F

Registered
êêF P
)
êêP Q
{
ëë 
logger
íí 
.
íí 
LogInformation
íí )
(
íí) *
$stríí* Å
,ííÅ Ç
	userEmail
ìì !
,
ìì! "
eventId
ìì# *
)
ìì* +
;
ìì+ ,
throw
îî 
new
îî '
InvalidOperationException
îî 7
(
îî7 8
$str
îî8 [
)
îî[ \
;
îî\ ]
}
ïï 
else
ññ 
{
óó 
logger
ôô 
.
ôô 
LogInformation
ôô )
(
ôô) *
$strôô* ì
,ôôì î
	userEmail
öö !
,
öö! "
eventId
öö# *
)
öö* +
;
öö+ ,"
existingRegistration
õõ (
.
õõ( )
Status
õõ) /
=
õõ0 1 
RegistrationStatus
õõ2 D
.
õõD E

Registered
õõE O
;
õõO P"
existingRegistration
úú (
.
úú( )
RegisteredAt
úú) 5
=
úú6 7
DateTime
úú8 @
.
úú@ A
UtcNow
úúA G
;
úúG H

unitOfWork
ùù 
.
ùù  
EventRegistrations
ùù 1
.
ùù1 2
Update
ùù2 8
(
ùù8 9"
existingRegistration
ùù9 M
)
ùùM N
;
ùùN O
}
ûû 
}
üü 
else
†† 
{
°° 
if
££ 
(
££ 
evt
££ 
.
££ 
MaxParticipants
££ '
.
££' (
HasValue
££( 0
)
££0 1
{
§§ 
var
•• 
currentCount
•• $
=
••% &
await
••' ,

unitOfWork
••- 7
.
••7 8
Events
••8 >
.
••> ?%
GetRegisteredCountAsync
••? V
(
••V W
eventId
••W ^
)
••^ _
;
••_ `
if
¶¶ 
(
¶¶ 
currentCount
¶¶ $
>=
¶¶% '
evt
¶¶( +
.
¶¶+ ,
MaxParticipants
¶¶, ;
.
¶¶; <
Value
¶¶< A
)
¶¶A B
{
ßß 
logger
®® 
.
®® 
LogInformation
®® -
(
®®- .
$str
®®. g
,
®®g h
eventId
®®i p
)
®®p q
;
®®q r
throw
©© 
new
©© !'
InvalidOperationException
©©" ;
(
©©; <
$str
©©< K
)
©©K L
;
©©L M
}
™™ 
}
´´ 
var
≠≠ 
registration
≠≠  
=
≠≠! "
new
≠≠# &!
EventRegistrationBo
≠≠' :
{
ÆÆ 
UserId
ØØ 
=
ØØ 
user
ØØ !
.
ØØ! "
Id
ØØ" $
,
ØØ$ %
EventId
∞∞ 
=
∞∞ 
eventId
∞∞ %
,
∞∞% &
RegisteredAt
±±  
=
±±! "
DateTime
±±# +
.
±±+ ,
UtcNow
±±, 2
,
±±2 3
SurveyJsData
≤≤  
=
≤≤! "
surveyJsData
≤≤# /
,
≤≤/ 0
Status
≥≥ 
=
≥≥  
RegistrationStatus
≥≥ /
.
≥≥/ 0

Registered
≥≥0 :
}
¥¥ 
;
¥¥ 
await
∂∂ 

unitOfWork
∂∂  
.
∂∂  ! 
EventRegistrations
∂∂! 3
.
∂∂3 4
AddAsync
∂∂4 <
(
∂∂< =
registration
∂∂= I
)
∂∂I J
;
∂∂J K
logger
∑∑ 
.
∑∑ 
LogInformation
∑∑ %
(
∑∑% &
$str∑∑& Ö
,∑∑Ö Ü
	userEmail
∏∏ 
,
∏∏ 
eventId
∏∏ &
)
∏∏& '
;
∏∏' (
}
ππ 
await
ªª 

unitOfWork
ªª 
.
ªª 
SaveChangesAsync
ªª -
(
ªª- .
)
ªª. /
;
ªª/ 0
await
ºº 

unitOfWork
ºº 
.
ºº $
CommitTransactionAsync
ºº 3
(
ºº3 4
)
ºº4 5
;
ºº5 6
logger
ææ 
.
ææ 
LogInformation
ææ !
(
ææ! "
$str
ææ" l
,
ææl m
eventId
øø 
,
øø 
	userEmail
øø "
)
øø" #
;
øø# $
return
¡¡ 
$str
¡¡ 6
;
¡¡6 7
}
¬¬ 	
catch
√√ 
{
ƒƒ 	
await
≈≈ 

unitOfWork
≈≈ 
.
≈≈ &
RollbackTransactionAsync
≈≈ 5
(
≈≈5 6
)
≈≈6 7
;
≈≈7 8
throw
∆∆ 
;
∆∆ 
}
«« 	
}
»» 
public
ÀÀ 

async
ÀÀ 
Task
ÀÀ 
<
ÀÀ 
string
ÀÀ 
>
ÀÀ &
UnregisterFromEventAsync
ÀÀ 6
(
ÀÀ6 7
int
ÀÀ7 :
eventId
ÀÀ; B
,
ÀÀB C
string
ÀÀD J
	userEmail
ÀÀK T
)
ÀÀT U
{
ÃÃ 
logger
ÕÕ 
.
ÕÕ 
LogInformation
ÕÕ 
(
ÕÕ 
$str
ÕÕ h
,
ÕÕh i
eventId
ŒŒ 
,
ŒŒ 
	userEmail
ŒŒ 
)
ŒŒ 
;
ŒŒ  
var
–– 
user
–– 
=
–– 
await
–– 

unitOfWork
–– #
.
––# $
Users
––$ )
.
––) *
GetByEmailAsync
––* 9
(
––9 :
	userEmail
––: C
)
––C D
;
––D E
if
—— 

(
—— 
user
—— 
==
—— 
null
—— 
)
—— 
{
““ 	
logger
”” 
.
”” 
LogError
”” 
(
”” 
$str
”” g
,
””g h
	userEmail
””i r
)
””r s
;
””s t
throw
‘‘ 
new
‘‘ )
UnauthorizedAccessException
‘‘ 1
(
‘‘1 2
$"
‘‘2 4
$str
‘‘4 D
{
‘‘D E
	userEmail
‘‘E N
}
‘‘N O
"
‘‘O P
)
‘‘P Q
;
‘‘Q R
}
’’ 	
var
◊◊ 
registration
◊◊ 
=
◊◊ 
await
◊◊  

unitOfWork
◊◊! +
.
◊◊+ ,
Events
◊◊, 2
.
◊◊2 3"
GetRegistrationAsync
◊◊3 G
(
◊◊G H
eventId
◊◊H O
,
◊◊O P
user
◊◊Q U
.
◊◊U V
Id
◊◊V X
)
◊◊X Y
;
◊◊Y Z
if
ŸŸ 

(
ŸŸ 
registration
ŸŸ 
==
ŸŸ 
null
ŸŸ  
||
ŸŸ! #
registration
ŸŸ$ 0
.
ŸŸ0 1
Status
ŸŸ1 7
==
ŸŸ8 : 
RegistrationStatus
ŸŸ; M
.
ŸŸM N
	Cancelled
ŸŸN W
)
ŸŸW X
{
⁄⁄ 	
logger
€€ 
.
€€ 

LogWarning
€€ 
(
€€ 
$str€€ É
,€€É Ñ
	userEmail
‹‹ 
,
‹‹ 
eventId
‹‹ "
)
‹‹" #
;
‹‹# $
throw
›› 
new
›› "
KeyNotFoundException
›› *
(
››* +
$str
››+ I
)
››I J
;
››J K
}
ﬁﬁ 	
registration
‡‡ 
.
‡‡ 
Status
‡‡ 
=
‡‡  
RegistrationStatus
‡‡ 0
.
‡‡0 1
	Cancelled
‡‡1 :
;
‡‡: ;

unitOfWork
·· 
.
··  
EventRegistrations
·· %
.
··% &
Update
··& ,
(
··, -
registration
··- 9
)
··9 :
;
··: ;
await
„„ 

unitOfWork
„„ 
.
„„ 
SaveChangesAsync
„„ )
(
„„) *
)
„„* +
;
„„+ ,
logger
ÂÂ 
.
ÂÂ 
LogInformation
ÂÂ 
(
ÂÂ 
$str
ÂÂ k
,
ÂÂk l
eventId
ÊÊ 
,
ÊÊ 
	userEmail
ÊÊ 
)
ÊÊ 
;
ÊÊ  
return
ËË 
$str
ËË 5
;
ËË5 6
}
ÈÈ 
public
ÏÏ 

async
ÏÏ 
Task
ÏÏ 
<
ÏÏ '
EventWithRegistrationsDto
ÏÏ /
?
ÏÏ/ 0
>
ÏÏ0 1(
GetEventRegistrationsAsync
ÏÏ2 L
(
ÏÏL M
int
ÏÏM P
eventId
ÏÏQ X
)
ÏÏX Y
{
ÌÌ 
logger
ÓÓ 
.
ÓÓ 
LogInformation
ÓÓ 
(
ÓÓ 
$str
ÓÓ _
,
ÓÓ_ `
eventId
ÓÓa h
)
ÓÓh i
;
ÓÓi j
var
 
evt
 
=
 
await
 

unitOfWork
 "
.
" #
Events
# )
.
) *&
GetEventWithDetailsAsync
* B
(
B C
eventId
C J
)
J K
;
K L
if
ÚÚ 

(
ÚÚ 
evt
ÚÚ 
==
ÚÚ 
null
ÚÚ 
)
ÚÚ 
{
ÛÛ 	
logger
ÙÙ 
.
ÙÙ 

LogWarning
ÙÙ 
(
ÙÙ 
$str
ÙÙ ^
,
ÙÙ^ _
eventId
ÙÙ` g
)
ÙÙg h
;
ÙÙh i
return
ıı 
null
ıı 
;
ıı 
}
ˆˆ 	
var
¯¯ 
result
¯¯ 
=
¯¯ 
mapper
¯¯ 
.
¯¯ 
Map
¯¯ 
<
¯¯  '
EventWithRegistrationsDto
¯¯  9
>
¯¯9 :
(
¯¯: ;
evt
¯¯; >
)
¯¯> ?
;
¯¯? @
logger
˙˙ 
.
˙˙ 
LogInformation
˙˙ 
(
˙˙ 
$str˙˙ É
,˙˙É Ñ
eventId
˚˚ 
,
˚˚ 
result
˚˚ 
.
˚˚ 
Registrations
˚˚ )
.
˚˚) *
Count
˚˚* /
)
˚˚/ 0
;
˚˚0 1
return
˝˝ 
result
˝˝ 
;
˝˝ 
}
˛˛ 
}ˇˇ €ë
QC:\Users\micha\Projects\ESN-WebApi\Business\EventTemplate\EventTemplateService.cs
	namespace		 	
Business		
 
.		 
EventTemplate		  
;		  !
public 
class  
EventTemplateService !
(! "
IUnitOfWork" -

unitOfWork. 8
,8 9
IMapper: A
mapperB H
,H I
ILoggerJ Q
<Q R 
EventTemplateServiceR f
>f g
loggerh n
)n o
: !
IEventTemplateService 
{ 
[ 
Obsolete 
( 
$str z
)z {
]{ |
public 

async 
Task 
< 
IEnumerable !
<! "
EventTemplateDto" 2
>2 3
>3 4 
GetAllTemplatesAsync5 I
(I J
)J K
{ 
logger 
. 
LogInformation 
( 
$str m
)m n
;n o
var 
	templates 
= 
await 

unitOfWork (
.( )
EventTemplates) 7
.7 8 
GetAllTemplatesAsync8 L
(L M
)M N
;N O
var 
templateDtos 
= 
mapper !
.! "
Map" %
<% &
IEnumerable& 1
<1 2
EventTemplateDto2 B
>B C
>C D
(D E
	templatesE N
)N O
;O P
logger 
. 
LogInformation 
( 
$str p
,p q
	templatesr {
.{ |
Count	| Å
(
Å Ç
)
Ç É
)
É Ñ
;
Ñ Ö
return 
templateDtos 
; 
} 
public!! 

async!! 
Task!! 
<!! 
PagedResult!! !
<!!! "
EventTemplateDto!!" 2
>!!2 3
>!!3 4 
GetAllTemplatesAsync!!5 I
(!!I J
PaginationParams!!J Z

pagination!![ e
)!!e f
{"" 
logger## 
.## 
LogInformation## 
(## 
$str	## Å
,
##Å Ç

pagination$$ 
.$$ 

PageNumber$$ !
,$$! "

pagination$$# -
.$$- .
PageSize$$. 6
)$$6 7
;$$7 8
var&& 
(&& 
items&& 
,&& 

totalCount&& 
)&& 
=&&  !
await&&" '

unitOfWork&&( 2
.&&2 3
EventTemplates&&3 A
.&&A B
GetPagedAsync&&B O
(&&O P

pagination'' 
.'' 
Skip'' 
,'' 

pagination(( 
.(( 
PageSize(( 
)((  
;((  !
var** 
dtos** 
=** 
mapper** 
.** 
Map** 
<** 
List** "
<**" #
EventTemplateDto**# 3
>**3 4
>**4 5
(**5 6
items**6 ;
)**; <
;**< =
logger,, 
.,, 
LogInformation,, 
(,, 
$str	,, Ç
,
,,Ç É
dtos-- 
.-- 
Count-- 
,-- 

totalCount-- "
)--" #
;--# $
return// 
new// 
PagedResult// 
<// 
EventTemplateDto// /
>/// 0
(//0 1
dtos//1 5
,//5 6

totalCount//7 A
,//A B

pagination//C M
.//M N

PageNumber//N X
,//X Y

pagination//Z d
.//d e
PageSize//e m
)//m n
;//n o
}00 
public33 

async33 
Task33 
<33 
EventTemplateDto33 &
?33& '
>33' ( 
GetTemplateByIdAsync33) =
(33= >
int33> A
id33B D
)33D E
{44 
logger55 
.55 
LogInformation55 
(55 
$str55 d
,55d e
id55f h
)55h i
;55i j
var77 
template77 
=77 
await77 

unitOfWork77 '
.77' (
EventTemplates77( 6
.776 7
GetByIdAsync777 C
(77C D
id77D F
)77F G
;77G H
if99 

(99 
template99 
==99 
null99 
)99 
{:: 	
logger;; 
.;; 

LogWarning;; 
(;; 
$str;; c
,;;c d
id;;e g
);;g h
;;;h i
return<< 
null<< 
;<< 
}== 	
var?? 
templateDto?? 
=?? 
mapper??  
.??  !
Map??! $
<??$ %
EventTemplateDto??% 5
>??5 6
(??6 7
template??7 ?
)??? @
;??@ A
loggerAA 
.AA 
LogInformationAA 
(AA 
$strAA g
,AAg h
idAAi k
)AAk l
;AAl m
returnCC 
templateDtoCC 
;CC 
}DD 
publicGG 

asyncGG 
TaskGG 
<GG 
EventTemplateDtoGG &
>GG& '
CreateTemplateAsyncGG( ;
(GG; <"
CreateEventTemplateDtoGG< R
createTemplateDtoGGS d
)GGd e
{HH 
loggerII 
.II 
LogInformationII 
(II 
$strII b
,IIb c
createTemplateDtoJJ 
.JJ 
TitleJJ #
)JJ# $
;JJ$ %
varLL 
templateLL 
=LL 
mapperLL 
.LL 
MapLL !
<LL! "
BoLL" $
.LL$ %
ModelsLL% +
.LL+ ,
EventTemplateBoLL, ;
>LL; <
(LL< =
createTemplateDtoLL= N
)LLN O
;LLO P
awaitNN 

unitOfWorkNN 
.NN 
EventTemplatesNN '
.NN' (
AddAsyncNN( 0
(NN0 1
templateNN1 9
)NN9 :
;NN: ;
awaitOO 

unitOfWorkOO 
.OO 
SaveChangesAsyncOO )
(OO) *
)OO* +
;OO+ ,
varQQ 
templateDtoQQ 
=QQ 
mapperQQ  
.QQ  !
MapQQ! $
<QQ$ %
EventTemplateDtoQQ% 5
>QQ5 6
(QQ6 7
templateQQ7 ?
)QQ? @
;QQ@ A
loggerSS 
.SS 
LogInformationSS 
(SS 
$strSS k
,SSk l
templateTT 
.TT 
IdTT 
)TT 
;TT 
returnVV 
templateDtoVV 
;VV 
}WW 
publicZZ 

asyncZZ 
TaskZZ 
<ZZ 
EventTemplateDtoZZ &
?ZZ& '
>ZZ' (
UpdateTemplateAsyncZZ) <
(ZZ< =
intZZ= @
idZZA C
,ZZC D
EventTemplateDtoZZE U
templateDtoZZV a
)ZZa b
{[[ 
logger\\ 
.\\ 
LogInformation\\ 
(\\ 
$str\\ c
,\\c d
id\\e g
)\\g h
;\\h i
var^^ 
template^^ 
=^^ 
await^^ 

unitOfWork^^ '
.^^' (
EventTemplates^^( 6
.^^6 7
GetByIdAsync^^7 C
(^^C D
id^^D F
)^^F G
;^^G H
if`` 

(`` 
template`` 
==`` 
null`` 
)`` 
{aa 	
loggerbb 
.bb 

LogWarningbb 
(bb 
$strbb b
,bbb c
idbbd f
)bbf g
;bbg h
returncc 
nullcc 
;cc 
}dd 	
templateff 
.ff 
Titleff 
=ff 
templateDtoff $
.ff$ %
Titleff% *
;ff* +
templategg 
.gg 
Descriptiongg 
=gg 
templateDtogg *
.gg* +
Descriptiongg+ 6
;gg6 7
templatehh 
.hh 
SurveyJsDatahh 
=hh 
templateDtohh  +
.hh+ ,
SurveyJsDatahh, 8
;hh8 9

unitOfWorkjj 
.jj 
EventTemplatesjj !
.jj! "
Updatejj" (
(jj( )
templatejj) 1
)jj1 2
;jj2 3
awaitkk 

unitOfWorkkk 
.kk 
SaveChangesAsynckk )
(kk) *
)kk* +
;kk+ ,
varmm 
updatedTemplateDtomm 
=mm  
mappermm! '
.mm' (
Mapmm( +
<mm+ ,
EventTemplateDtomm, <
>mm< =
(mm= >
templatemm> F
)mmF G
;mmG H
loggeroo 
.oo 
LogInformationoo 
(oo 
$stroo f
,oof g
idooh j
)ooj k
;ook l
returnqq 
updatedTemplateDtoqq !
;qq! "
}rr 
publicuu 

asyncuu 
Taskuu 
<uu 
booluu 
>uu 
DeleteTemplateAsyncuu /
(uu/ 0
intuu0 3
iduu4 6
)uu6 7
{vv 
loggerww 
.ww 
LogInformationww 
(ww 
$strww c
,wwc d
idwwe g
)wwg h
;wwh i
varyy 
templateyy 
=yy 
awaityy 

unitOfWorkyy '
.yy' (
EventTemplatesyy( 6
.yy6 7
GetByIdAsyncyy7 C
(yyC D
idyyD F
)yyF G
;yyG H
if{{ 

({{ 
template{{ 
=={{ 
null{{ 
){{ 
{|| 	
logger}} 
.}} 

LogWarning}} 
(}} 
$str}} b
,}}b c
id}}d f
)}}f g
;}}g h
return~~ 
false~~ 
;~~ 
} 	

unitOfWork
ÅÅ 
.
ÅÅ 
EventTemplates
ÅÅ !
.
ÅÅ! "
Delete
ÅÅ" (
(
ÅÅ( )
template
ÅÅ) 1
)
ÅÅ1 2
;
ÅÅ2 3
await
ÇÇ 

unitOfWork
ÇÇ 
.
ÇÇ 
SaveChangesAsync
ÇÇ )
(
ÇÇ) *
)
ÇÇ* +
;
ÇÇ+ ,
logger
ÑÑ 
.
ÑÑ 
LogInformation
ÑÑ 
(
ÑÑ 
$str
ÑÑ f
,
ÑÑf g
id
ÑÑh j
)
ÑÑj k
;
ÑÑk l
return
ÜÜ 
true
ÜÜ 
;
ÜÜ 
}
áá 
public
ää 

async
ää 
Task
ää 
<
ää 
EventDto
ää 
>
ää *
CreateEventFromTemplateAsync
ää  <
(
ää< =(
CreateEventFromTemplateDto
ää= W(
createEventFromTemplateDto
ääX r
,
äär s
string
äät z
	userEmailää{ Ñ
)ääÑ Ö
{
ãã 
logger
åå 
.
åå 
LogInformation
åå 
(
åå 
$stråå Ä
,ååÄ Å(
createEventFromTemplateDto
çç &
.
çç& '

TemplateId
çç' 1
,
çç1 2
	userEmail
çç3 <
)
çç< =
;
çç= >
var
èè 
user
èè 
=
èè 
await
èè 

unitOfWork
èè #
.
èè# $
Users
èè$ )
.
èè) *
GetByEmailAsync
èè* 9
(
èè9 :
	userEmail
èè: C
)
èèC D
;
èèD E
if
êê 

(
êê 
user
êê 
==
êê 
null
êê 
)
êê 
{
ëë 	
logger
íí 
.
íí 
LogError
íí 
(
íí 
$str
íí s
,
íís t
	userEmail
ííu ~
)
íí~ 
;íí Ä
throw
ìì 
new
ìì )
UnauthorizedAccessException
ìì 1
(
ìì1 2
$"
ìì2 4
$str
ìì4 D
{
ììD E
	userEmail
ììE N
}
ììN O
"
ììO P
)
ììP Q
;
ììQ R
}
îî 	
var
ññ 
template
ññ 
=
ññ 
await
ññ 

unitOfWork
ññ '
.
ññ' (
EventTemplates
ññ( 6
.
ññ6 7
GetByIdAsync
ññ7 C
(
ññC D(
createEventFromTemplateDto
ññD ^
.
ññ^ _

TemplateId
ññ_ i
)
ññi j
;
ññj k
if
óó 

(
óó 
template
óó 
==
óó 
null
óó 
)
óó 
{
òò 	
logger
ôô 
.
ôô 
LogError
ôô 
(
ôô 
$str
ôô x
,
ôôx y(
createEventFromTemplateDto
öö *
.
öö* +

TemplateId
öö+ 5
)
öö5 6
;
öö6 7
throw
õõ 
new
õõ 
ArgumentException
õõ '
(
õõ' (
$"
õõ( *
$str
õõ* >
{
õõ> ?(
createEventFromTemplateDto
õõ? Y
.
õõY Z

TemplateId
õõZ d
}
õõd e
"
õõe f
)
õõf g
;
õõg h
}
úú 	
var
ûû 
evt
ûû 
=
ûû 
new
ûû 
Bo
ûû 
.
ûû 
Models
ûû 
.
ûû  
EventBo
ûû  '
{
üü 	
Title
†† 
=
†† (
createEventFromTemplateDto
†† .
.
††. /
Title
††/ 4
,
††4 5
Description
°° 
=
°° (
createEventFromTemplateDto
°° 4
.
°°4 5
Description
°°5 @
??
°°A C
template
°°D L
.
°°L M
Description
°°M X
,
°°X Y
Location
¢¢ 
=
¢¢ (
createEventFromTemplateDto
¢¢ 1
.
¢¢1 2
Location
¢¢2 :
,
¢¢: ;
	StartDate
££ 
=
££ (
createEventFromTemplateDto
££ 2
.
££2 3
	StartDate
££3 <
,
££< =
EndDate
§§ 
=
§§ (
createEventFromTemplateDto
§§ 0
.
§§0 1
EndDate
§§1 8
,
§§8 9
MaxParticipants
•• 
=
•• (
createEventFromTemplateDto
•• 8
.
••8 9
MaxParticipants
••9 H
,
••H I
EventfrogLink
¶¶ 
=
¶¶ (
createEventFromTemplateDto
¶¶ 6
.
¶¶6 7
EventfrogLink
¶¶7 D
,
¶¶D E
SurveyJsData
ßß 
=
ßß (
createEventFromTemplateDto
ßß 5
.
ßß5 6
SurveyJsData
ßß6 B
??
ßßC E
template
ßßF N
.
ßßN O
SurveyJsData
ßßO [
,
ßß[ \
UserId
®® 
=
®® 
user
®® 
.
®® 
Id
®® 
}
©© 	
;
©©	 

await
´´ 

unitOfWork
´´ 
.
´´ 
Events
´´ 
.
´´  
AddAsync
´´  (
(
´´( )
evt
´´) ,
)
´´, -
;
´´- .
await
¨¨ 

unitOfWork
¨¨ 
.
¨¨ 
SaveChangesAsync
¨¨ )
(
¨¨) *
)
¨¨* +
;
¨¨+ ,
var
ÆÆ 
eventDto
ÆÆ 
=
ÆÆ 
mapper
ÆÆ 
.
ÆÆ 
Map
ÆÆ !
<
ÆÆ! "
EventDto
ÆÆ" *
>
ÆÆ* +
(
ÆÆ+ ,
evt
ÆÆ, /
)
ÆÆ/ 0
;
ÆÆ0 1
logger
∞∞ 
.
∞∞ 
LogInformation
∞∞ 
(
∞∞ 
$str
∞∞ q
,
∞∞q r
evt
±± 
.
±± 
Id
±± 
)
±± 
;
±± 
return
≥≥ 
eventDto
≥≥ 
;
≥≥ 
}
¥¥ 
public
∑∑ 

async
∑∑ 
Task
∑∑ 
<
∑∑ 
EventTemplateDto
∑∑ &
>
∑∑& '&
SaveEventAsTemplateAsync
∑∑( @
(
∑∑@ A
int
∑∑A D
eventId
∑∑E L
)
∑∑L M
{
∏∏ 
logger
ππ 
.
ππ 
LogInformation
ππ 
(
ππ 
$str
ππ j
,
ππj k
eventId
ππl s
)
ππs t
;
ππt u
var
ªª 
evt
ªª 
=
ªª 
await
ªª 

unitOfWork
ªª "
.
ªª" #
Events
ªª# )
.
ªª) *
GetByIdAsync
ªª* 6
(
ªª6 7
eventId
ªª7 >
)
ªª> ?
;
ªª? @
if
ºº 

(
ºº 
evt
ºº 
==
ºº 
null
ºº 
)
ºº 
{
ΩΩ 	
logger
ææ 
.
ææ 
LogError
ææ 
(
ææ 
$str
ææ n
,
ææn o
eventId
ææp w
)
ææw x
;
ææx y
throw
øø 
new
øø 
ArgumentException
øø '
(
øø' (
$"
øø( *
$str
øø* ;
{
øø; <
eventId
øø< C
}
øøC D
"
øøD E
)
øøE F
;
øøF G
}
¿¿ 	
var
¬¬ 
template
¬¬ 
=
¬¬ 
new
¬¬ 
Bo
¬¬ 
.
¬¬ 
Models
¬¬ $
.
¬¬$ %
EventTemplateBo
¬¬% 4
{
√√ 	
Title
ƒƒ 
=
ƒƒ 
evt
ƒƒ 
.
ƒƒ 
Title
ƒƒ 
,
ƒƒ 
Description
≈≈ 
=
≈≈ 
evt
≈≈ 
.
≈≈ 
Description
≈≈ )
??
≈≈* ,
string
≈≈- 3
.
≈≈3 4
Empty
≈≈4 9
,
≈≈9 :
SurveyJsData
∆∆ 
=
∆∆ 
evt
∆∆ 
.
∆∆ 
SurveyJsData
∆∆ +
??
∆∆, .
string
∆∆/ 5
.
∆∆5 6
Empty
∆∆6 ;
}
«« 	
;
««	 

await
…… 

unitOfWork
…… 
.
…… 
EventTemplates
…… '
.
……' (
AddAsync
……( 0
(
……0 1
template
……1 9
)
……9 :
;
……: ;
await
   

unitOfWork
   
.
   
SaveChangesAsync
   )
(
  ) *
)
  * +
;
  + ,
var
ÃÃ 
templateDto
ÃÃ 
=
ÃÃ 
mapper
ÃÃ  
.
ÃÃ  !
Map
ÃÃ! $
<
ÃÃ$ %
EventTemplateDto
ÃÃ% 5
>
ÃÃ5 6
(
ÃÃ6 7
template
ÃÃ7 ?
)
ÃÃ? @
;
ÃÃ@ A
logger
ŒŒ 
.
ŒŒ 
LogInformation
ŒŒ 
(
ŒŒ 
$str
ŒŒ p
,
ŒŒp q
template
œœ 
.
œœ 
Id
œœ 
)
œœ 
;
œœ 
return
—— 
templateDto
—— 
;
—— 
}
““ 
}”” ±∞
GC:\Users\micha\Projects\ESN-WebApi\Business\Calendar\CalendarService.cs
	namespace		 	
Business		
 
.		 
Calendar		 
;		 
public 
class 
CalendarService 
( 
IUnitOfWork (

unitOfWork) 3
,3 4
IMapper5 <
mapper= C
,C D
ILoggerE L
<L M
CalendarServiceM \
>\ ]
logger^ d
)d e
: 
ICalendarService 
{ 
[ 
Obsolete 
( 
$str z
)z {
]{ |
public 

async 
Task 
< 
IEnumerable !
<! "
CalendarDto" -
>- .
>. / 
GetAllCalendarsAsync0 D
(D E
)E F
{ 
logger 
. 
LogInformation 
( 
$str h
)h i
;i j
var 
	calendars 
= 
await 

unitOfWork (
.( )
	Calendars) 2
.2 3+
GetAllCalendarsWithDetailsAsync3 R
(R S
)S T
;T U
logger 
. 
LogInformation 
( 
$str k
,k l
	calendarsm v
.v w
Countw |
(| }
)} ~
)~ 
;	 Ä
return 
mapper 
. 
Map 
< 
IEnumerable %
<% &
CalendarDto& 1
>1 2
>2 3
(3 4
	calendars4 =
)= >
;> ?
} 
public 

async 
Task 
< 
PagedResult !
<! "
CalendarDto" -
>- .
>. / 
GetAllCalendarsAsync0 D
(D E
PaginationParamsE U

paginationV `
)` a
{   
logger!! 
.!! 
LogInformation!! 
(!! 
$str!! |
,!!| }

pagination"" 
."" 

PageNumber"" !
,""! "

pagination""# -
.""- .
PageSize"". 6
)""6 7
;""7 8
var$$ 
($$ 
items$$ 
,$$ 

totalCount$$ 
)$$ 
=$$  !
await$$" '

unitOfWork$$( 2
.$$2 3
	Calendars$$3 <
.$$< =
GetPagedAsync$$= J
($$J K

pagination%% 
.%% 
Skip%% 
,%% 

pagination&& 
.&& 
PageSize&& 
)&&  
;&&  !
var(( 
dtos(( 
=(( 
mapper(( 
.(( 
Map(( 
<(( 
List(( "
<((" #
CalendarDto((# .
>((. /
>((/ 0
(((0 1
items((1 6
)((6 7
;((7 8
logger** 
.** 
LogInformation** 
(** 
$str** }
,**} ~
dtos++ 
.++ 
Count++ 
,++ 

totalCount++ "
)++" #
;++# $
return-- 
new-- 
PagedResult-- 
<-- 
CalendarDto-- *
>--* +
(--+ ,
dtos--, 0
,--0 1

totalCount--2 <
,--< =

pagination--> H
.--H I

PageNumber--I S
,--S T

pagination--U _
.--_ `
PageSize--` h
)--h i
;--i j
}.. 
public11 

async11 
Task11 
<11 
CalendarDto11 !
?11! "
>11" # 
GetCalendarByIdAsync11$ 8
(118 9
int119 <
id11= ?
)11? @
{22 
logger33 
.33 
LogInformation33 
(33 
$str33 _
,33_ `
id33a c
)33c d
;33d e
var55 
calendar55 
=55 
await55 

unitOfWork55 '
.55' (
	Calendars55( 1
.551 2'
GetCalendarWithDetailsAsync552 M
(55M N
id55N P
)55P Q
;55Q R
if77 

(77 
calendar77 
==77 
null77 
)77 
{88 	
logger99 
.99 

LogWarning99 
(99 
$str99 ^
,99^ _
id99` b
)99b c
;99c d
return:: 
null:: 
;:: 
};; 	
logger== 
.== 
LogInformation== 
(== 
$str== b
,==b c
id==d f
)==f g
;==g h
return?? 
mapper?? 
.?? 
Map?? 
<?? 
CalendarDto?? %
>??% &
(??& '
calendar??' /
)??/ 0
;??0 1
}@@ 
publicCC 

asyncCC 
TaskCC 
<CC 
IEnumerableCC !
<CC! "
CalendarDtoCC" -
>CC- .
>CC. /&
GetCalendarsByEventIdAsyncCC0 J
(CCJ K
intCCK N
eventIdCCO V
)CCV W
{DD 
loggerEE 
.EE 
LogInformationEE 
(EE 
$strEE g
,EEg h
eventIdEEi p
)EEp q
;EEq r
varGG 
	calendarsGG 
=GG 
awaitGG 

unitOfWorkGG (
.GG( )
	CalendarsGG) 2
.GG2 3&
GetCalendarsByEventIdAsyncGG3 M
(GGM N
eventIdGGN U
)GGU V
;GGV W
loggerII 
.II 
LogInformationII 
(II 
$str	II á
,
IIá à
eventIdJJ 
,JJ 
	calendarsJJ 
.JJ 
CountJJ $
(JJ$ %
)JJ% &
)JJ& '
;JJ' (
returnLL 
mapperLL 
.LL 
MapLL 
<LL 
IEnumerableLL %
<LL% &
CalendarDtoLL& 1
>LL1 2
>LL2 3
(LL3 4
	calendarsLL4 =
)LL= >
;LL> ?
}MM 
publicPP 

asyncPP 
TaskPP 
<PP 
IEnumerablePP !
<PP! "
CalendarDtoPP" -
>PP- .
>PP. /&
GetAvailableCalendarsAsyncPP0 J
(PPJ K
)PPK L
{QQ 
loggerRR 
.RR 
LogInformationRR 
(RR 
$strRR Q
)RRQ R
;RRR S
varTT 
	calendarsTT 
=TT 
awaitTT 

unitOfWorkTT (
.TT( )
	CalendarsTT) 2
.TT2 3)
GetCalendarsWithoutEventAsyncTT3 P
(TTP Q
)TTQ R
;TTR S
loggerVV 
.VV 
LogInformationVV 
(VV 
$strVV q
,VVq r
	calendarsWW 
.WW 
CountWW 
(WW 
)WW 
)WW 
;WW 
returnYY 
mapperYY 
.YY 
MapYY 
<YY 
IEnumerableYY %
<YY% &
CalendarDtoYY& 1
>YY1 2
>YY2 3
(YY3 4
	calendarsYY4 =
)YY= >
;YY> ?
}ZZ 
public]] 

async]] 
Task]] 
<]] 
CalendarDto]] !
>]]! "
CreateCalendarAsync]]# 6
(]]6 7
CalendarCreateDto]]7 H
	createDto]]I R
)]]R S
{^^ 
logger__ 
.__ 
LogInformation__ 
(__ 
$str__ ]
,__] ^
	createDto___ h
.__h i
Title__i n
)__n o
;__o p
tryaa 
{bb 	
awaitcc 

unitOfWorkcc 
.cc !
BeginTransactionAsynccc 2
(cc2 3
)cc3 4
;cc4 5
varee 
calendaree 
=ee 
mapperee !
.ee! "
Mapee" %
<ee% &
Boee& (
.ee( )
Modelsee) /
.ee/ 0

CalendarBoee0 :
>ee: ;
(ee; <
	createDtoee< E
)eeE F
;eeF G
awaitgg 

unitOfWorkgg 
.gg 
	Calendarsgg &
.gg& '
AddAsyncgg' /
(gg/ 0
calendargg0 8
)gg8 9
;gg9 :
awaithh 

unitOfWorkhh 
.hh 
SaveChangesAsynchh -
(hh- .
)hh. /
;hh/ 0
loggerjj 
.jj 
LogInformationjj !
(jj! "
$strjj" g
,jjg h
calendarjji q
.jjq r
Idjjr t
)jjt u
;jju v
ifmm 
(mm 
	createDtomm 
.mm 
SubOrganizerIdsmm )
!=mm* ,
nullmm- 1
&&mm2 4
	createDtomm5 >
.mm> ?
SubOrganizerIdsmm? N
.mmN O
AnymmO R
(mmR S
)mmS T
)mmT U
{nn 
loggeroo 
.oo 
LogInformationoo %
(oo% &
$stroo& k
,ook l
	createDtopp 
.pp 
SubOrganizerIdspp -
.pp- .
Countpp. 3
)pp3 4
;pp4 5
foreachrr 
(rr 
varrr 
userIdrr #
inrr$ &
	createDtorr' 0
.rr0 1
SubOrganizerIdsrr1 @
)rr@ A
{ss 
awaittt 

unitOfWorktt $
.tt$ %!
CalendarSubOrganizerstt% :
.tt: ;
AddAsynctt; C
(ttC D
newttD G"
CalendarSubOrganizerBottH ^
{uu 

CalendarIdvv "
=vv# $
calendarvv% -
.vv- .
Idvv. 0
,vv0 1
UserIdww 
=ww  
userIdww! '
}xx 
)xx 
;xx 
}yy 
awaitzz 

unitOfWorkzz  
.zz  !
SaveChangesAsynczz! 1
(zz1 2
)zz2 3
;zz3 4
}{{ 
await}} 

unitOfWork}} 
.}} "
CommitTransactionAsync}} 3
(}}3 4
)}}4 5
;}}5 6
calendar
ÄÄ 
=
ÄÄ 
await
ÄÄ 

unitOfWork
ÄÄ '
.
ÄÄ' (
	Calendars
ÄÄ( 1
.
ÄÄ1 2)
GetCalendarWithDetailsAsync
ÄÄ2 M
(
ÄÄM N
calendar
ÄÄN V
.
ÄÄV W
Id
ÄÄW Y
)
ÄÄY Z
;
ÄÄZ [
logger
ÇÇ 
.
ÇÇ 
LogInformation
ÇÇ !
(
ÇÇ! "
$str
ÇÇ" e
,
ÇÇe f
calendar
ÇÇg o
!
ÇÇo p
.
ÇÇp q
Id
ÇÇq s
)
ÇÇs t
;
ÇÇt u
return
ÑÑ 
mapper
ÑÑ 
.
ÑÑ 
Map
ÑÑ 
<
ÑÑ 
CalendarDto
ÑÑ )
>
ÑÑ) *
(
ÑÑ* +
calendar
ÑÑ+ 3
)
ÑÑ3 4
;
ÑÑ4 5
}
ÖÖ 	
catch
ÜÜ 
(
ÜÜ 
	Exception
ÜÜ 
ex
ÜÜ 
)
ÜÜ 
{
áá 	
logger
àà 
.
àà 
LogError
àà 
(
àà 
ex
àà 
,
àà 
$str
àà  y
)
àày z
;
ààz {
await
ââ 

unitOfWork
ââ 
.
ââ &
RollbackTransactionAsync
ââ 5
(
ââ5 6
)
ââ6 7
;
ââ7 8
throw
ää 
;
ää 
}
ãã 	
}
åå 
public
èè 

async
èè 
Task
èè 
<
èè 
CalendarDto
èè !
?
èè! "
>
èè" #!
UpdateCalendarAsync
èè$ 7
(
èè7 8
int
èè8 ;
id
èè< >
,
èè> ?
CalendarUpdateDto
èè@ Q
	updateDto
èèR [
,
èè[ \
string
èè] c
	userEmail
èèd m
)
èèm n
{
êê 
logger
ëë 
.
ëë 
LogInformation
ëë 
(
ëë 
$str
ëë i
,
ëëi j
id
ëëk m
,
ëëm n
	userEmail
ëëo x
)
ëëx y
;
ëëy z
var
ìì 
calendar
ìì 
=
ìì 
await
ìì 

unitOfWork
ìì '
.
ìì' (
	Calendars
ìì( 1
.
ìì1 2
GetByIdAsync
ìì2 >
(
ìì> ?
id
ìì? A
)
ììA B
;
ììB C
if
ïï 

(
ïï 
calendar
ïï 
==
ïï 
null
ïï 
)
ïï 
{
ññ 	
logger
óó 
.
óó 

LogWarning
óó 
(
óó 
$str
óó ]
,
óó] ^
id
óó_ a
)
óóa b
;
óób c
return
òò 
null
òò 
;
òò 
}
ôô 	
var
úú 
user
úú 
=
úú 
await
úú 

unitOfWork
úú #
.
úú# $
Users
úú$ )
.
úú) *
GetByEmailAsync
úú* 9
(
úú9 :
	userEmail
úú: C
)
úúC D
;
úúD E
if
ùù 

(
ùù 
user
ùù 
==
ùù 
null
ùù 
)
ùù 
{
ûû 	
logger
üü 
.
üü 
LogError
üü 
(
üü 
$str
üü ^
,
üü^ _
	userEmail
üü` i
)
üüi j
;
üüj k
throw
†† 
new
†† )
UnauthorizedAccessException
†† 1
(
††1 2
$"
††2 4
$str
††4 D
{
††D E
	userEmail
††E N
}
††N O
"
††O P
)
††P Q
;
††Q R
}
°° 	
if
§§ 

(
§§ 
calendar
§§ 
.
§§ 
MainOrganizerId
§§ $
!=
§§% '
user
§§( ,
.
§§, -
Id
§§- /
)
§§/ 0
{
•• 	
logger
¶¶ 
.
¶¶ 

LogWarning
¶¶ 
(
¶¶ 
$str¶¶ ô
,¶¶ô ö
	userEmail
ßß 
,
ßß 
user
ßß 
.
ßß  
Id
ßß  "
,
ßß" #
id
ßß$ &
,
ßß& '
calendar
ßß( 0
.
ßß0 1
MainOrganizerId
ßß1 @
)
ßß@ A
;
ßßA B
throw
®® 
new
®® )
UnauthorizedAccessException
®® 1
(
®®1 2
$str
®®2 e
)
®®e f
;
®®f g
}
©© 	
try
´´ 
{
¨¨ 	
await
≠≠ 

unitOfWork
≠≠ 
.
≠≠ #
BeginTransactionAsync
≠≠ 2
(
≠≠2 3
)
≠≠3 4
;
≠≠4 5
mapper
ØØ 
.
ØØ 
Map
ØØ 
(
ØØ 
	updateDto
ØØ  
,
ØØ  !
calendar
ØØ" *
)
ØØ* +
;
ØØ+ ,
if
≤≤ 
(
≤≤ 
	updateDto
≤≤ 
.
≤≤ 
SubOrganizerIds
≤≤ )
!=
≤≤* ,
null
≤≤- 1
)
≤≤1 2
{
≥≥ 
logger
¥¥ 
.
¥¥ 
LogInformation
¥¥ %
(
¥¥% &
$str
¥¥& y
,
¥¥y z
id
¥¥{ }
)
¥¥} ~
;
¥¥~ 
var
∑∑ #
existingSubOrganizers
∑∑ )
=
∑∑* +
await
∑∑, 1

unitOfWork
∑∑2 <
.
∑∑< =#
CalendarSubOrganizers
∑∑= R
.
∑∑R S
	FindAsync
∑∑S \
(
∑∑\ ]
cso
∑∑] `
=>
∑∑a c
cso
∑∑d g
.
∑∑g h

CalendarId
∑∑h r
==
∑∑s u
id
∑∑v x
)
∑∑x y
;
∑∑y z
foreach
∏∏ 
(
∏∏ 
var
∏∏ 
subOrganizer
∏∏ )
in
∏∏* ,#
existingSubOrganizers
∏∏- B
)
∏∏B C
{
ππ 

unitOfWork
∫∫ 
.
∫∫ #
CalendarSubOrganizers
∫∫ 4
.
∫∫4 5
Delete
∫∫5 ;
(
∫∫; <
subOrganizer
∫∫< H
)
∫∫H I
;
∫∫I J
}
ªª 
foreach
ææ 
(
ææ 
var
ææ 
userId
ææ #
in
ææ$ &
	updateDto
ææ' 0
.
ææ0 1
SubOrganizerIds
ææ1 @
)
ææ@ A
{
øø 
await
¿¿ 

unitOfWork
¿¿ $
.
¿¿$ %#
CalendarSubOrganizers
¿¿% :
.
¿¿: ;
AddAsync
¿¿; C
(
¿¿C D
new
¿¿D G$
CalendarSubOrganizerBo
¿¿H ^
{
¡¡ 

CalendarId
¬¬ "
=
¬¬# $
calendar
¬¬% -
.
¬¬- .
Id
¬¬. 0
,
¬¬0 1
UserId
√√ 
=
√√  
userId
√√! '
}
ƒƒ 
)
ƒƒ 
;
ƒƒ 
}
≈≈ 
}
∆∆ 

unitOfWork
»» 
.
»» 
	Calendars
»»  
.
»»  !
Update
»»! '
(
»»' (
calendar
»»( 0
)
»»0 1
;
»»1 2
await
…… 

unitOfWork
…… 
.
…… 
SaveChangesAsync
…… -
(
……- .
)
……. /
;
……/ 0
await
ÀÀ 

unitOfWork
ÀÀ 
.
ÀÀ $
CommitTransactionAsync
ÀÀ 3
(
ÀÀ3 4
)
ÀÀ4 5
;
ÀÀ5 6
logger
ÕÕ 
.
ÕÕ 
LogInformation
ÕÕ !
(
ÕÕ! "
$str
ÕÕ" l
,
ÕÕl m
id
ÕÕn p
)
ÕÕp q
;
ÕÕq r
}
ŒŒ 	
catch
œœ 
(
œœ 
	Exception
œœ 
ex
œœ 
)
œœ 
{
–– 	
logger
—— 
.
—— 
LogError
—— 
(
—— 
ex
—— 
,
—— 
$str
——  y
)
——y z
;
——z {
await
““ 

unitOfWork
““ 
.
““ &
RollbackTransactionAsync
““ 5
(
““5 6
)
““6 7
;
““7 8
if
‘‘ 
(
‘‘ 
!
‘‘ 
await
‘‘ 

unitOfWork
‘‘ !
.
‘‘! "
	Calendars
‘‘" +
.
‘‘+ ,
AnyAsync
‘‘, 4
(
‘‘4 5
e
‘‘5 6
=>
‘‘7 9
e
‘‘: ;
.
‘‘; <
Id
‘‘< >
==
‘‘? A
id
‘‘B D
)
‘‘D E
)
‘‘E F
{
’’ 
logger
÷÷ 
.
÷÷ 

LogWarning
÷÷ !
(
÷÷! "
$str÷÷" É
,÷÷É Ñ
id÷÷Ö á
)÷÷á à
;÷÷à â
return
◊◊ 
null
◊◊ 
;
◊◊ 
}
ÿÿ 
throw
ŸŸ 
;
ŸŸ 
}
⁄⁄ 	
calendar
›› 
=
›› 
await
›› 

unitOfWork
›› #
.
››# $
	Calendars
››$ -
.
››- .)
GetCalendarWithDetailsAsync
››. I
(
››I J
id
››J L
)
››L M
;
››M N
logger
ﬂﬂ 
.
ﬂﬂ 
LogInformation
ﬂﬂ 
(
ﬂﬂ 
$str
ﬂﬂ a
,
ﬂﬂa b
id
ﬂﬂc e
)
ﬂﬂe f
;
ﬂﬂf g
return
·· 
mapper
·· 
.
·· 
Map
·· 
<
·· 
CalendarDto
·· %
>
··% &
(
··& '
calendar
··' /
)
··/ 0
;
··0 1
}
‚‚ 
public
ÂÂ 

async
ÂÂ 
Task
ÂÂ 
<
ÂÂ 
CalendarDto
ÂÂ !
?
ÂÂ! "
>
ÂÂ" #!
DeleteCalendarAsync
ÂÂ$ 7
(
ÂÂ7 8
int
ÂÂ8 ;
id
ÂÂ< >
,
ÂÂ> ?
string
ÂÂ@ F
	userEmail
ÂÂG P
)
ÂÂP Q
{
ÊÊ 
logger
ÁÁ 
.
ÁÁ 
LogInformation
ÁÁ 
(
ÁÁ 
$str
ÁÁ i
,
ÁÁi j
id
ÁÁk m
,
ÁÁm n
	userEmail
ÁÁo x
)
ÁÁx y
;
ÁÁy z
var
ÈÈ 
calendar
ÈÈ 
=
ÈÈ 
await
ÈÈ 

unitOfWork
ÈÈ '
.
ÈÈ' (
	Calendars
ÈÈ( 1
.
ÈÈ1 2)
GetCalendarWithDetailsAsync
ÈÈ2 M
(
ÈÈM N
id
ÈÈN P
)
ÈÈP Q
;
ÈÈQ R
if
ÎÎ 

(
ÎÎ 
calendar
ÎÎ 
==
ÎÎ 
null
ÎÎ 
)
ÎÎ 
{
ÏÏ 	
logger
ÌÌ 
.
ÌÌ 

LogWarning
ÌÌ 
(
ÌÌ 
$str
ÌÌ ]
,
ÌÌ] ^
id
ÌÌ_ a
)
ÌÌa b
;
ÌÌb c
return
ÓÓ 
null
ÓÓ 
;
ÓÓ 
}
ÔÔ 	
var
ÚÚ 
user
ÚÚ 
=
ÚÚ 
await
ÚÚ 

unitOfWork
ÚÚ #
.
ÚÚ# $
Users
ÚÚ$ )
.
ÚÚ) *
GetByEmailAsync
ÚÚ* 9
(
ÚÚ9 :
	userEmail
ÚÚ: C
)
ÚÚC D
;
ÚÚD E
if
ÛÛ 

(
ÛÛ 
user
ÛÛ 
==
ÛÛ 
null
ÛÛ 
)
ÛÛ 
{
ÙÙ 	
logger
ıı 
.
ıı 
LogError
ıı 
(
ıı 
$str
ıı ^
,
ıı^ _
	userEmail
ıı` i
)
ııi j
;
ııj k
throw
ˆˆ 
new
ˆˆ )
UnauthorizedAccessException
ˆˆ 1
(
ˆˆ1 2
$"
ˆˆ2 4
$str
ˆˆ4 D
{
ˆˆD E
	userEmail
ˆˆE N
}
ˆˆN O
"
ˆˆO P
)
ˆˆP Q
;
ˆˆQ R
}
˜˜ 	
if
˙˙ 

(
˙˙ 
calendar
˙˙ 
.
˙˙ 
MainOrganizerId
˙˙ $
!=
˙˙% '
user
˙˙( ,
.
˙˙, -
Id
˙˙- /
)
˙˙/ 0
{
˚˚ 	
logger
¸¸ 
.
¸¸ 

LogWarning
¸¸ 
(
¸¸ 
$str¸¸ ô
,¸¸ô ö
	userEmail
˝˝ 
,
˝˝ 
user
˝˝ 
.
˝˝  
Id
˝˝  "
,
˝˝" #
id
˝˝$ &
,
˝˝& '
calendar
˝˝( 0
.
˝˝0 1
MainOrganizerId
˝˝1 @
)
˝˝@ A
;
˝˝A B
throw
˛˛ 
new
˛˛ )
UnauthorizedAccessException
˛˛ 1
(
˛˛1 2
$str
˛˛2 e
)
˛˛e f
;
˛˛f g
}
ˇˇ 	

unitOfWork
ÅÅ 
.
ÅÅ 
	Calendars
ÅÅ 
.
ÅÅ 
Delete
ÅÅ #
(
ÅÅ# $
calendar
ÅÅ$ ,
)
ÅÅ, -
;
ÅÅ- .
await
ÇÇ 

unitOfWork
ÇÇ 
.
ÇÇ 
SaveChangesAsync
ÇÇ )
(
ÇÇ) *
)
ÇÇ* +
;
ÇÇ+ ,
logger
ÑÑ 
.
ÑÑ 
LogInformation
ÑÑ 
(
ÑÑ 
$str
ÑÑ a
,
ÑÑa b
id
ÑÑc e
)
ÑÑe f
;
ÑÑf g
return
ÜÜ 
mapper
ÜÜ 
.
ÜÜ 
Map
ÜÜ 
<
ÜÜ 
CalendarDto
ÜÜ %
>
ÜÜ% &
(
ÜÜ& '
calendar
ÜÜ' /
)
ÜÜ/ 0
;
ÜÜ0 1
}
áá 
}ââ 